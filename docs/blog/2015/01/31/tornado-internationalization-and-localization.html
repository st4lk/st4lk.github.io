<!DOCTYPE html>
<html lang="ru"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Tornado i18n и l10n | Developer articles</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Tornado i18n и l10n" />
<meta property="og:locale" content="ru" />
<meta name="description" content="Star Статья о том, что такое i18n и i10n и как это реализовать в приложении на tornado. Получилось довольно много букв, но хотелось рассказать доступно обо всем процессе. Сама пошаговая инструкция - во второй половине статьи." />
<meta property="og:description" content="Star Статья о том, что такое i18n и i10n и как это реализовать в приложении на tornado. Получилось довольно много букв, но хотелось рассказать доступно обо всем процессе. Сама пошаговая инструкция - во второй половине статьи." />
<link rel="canonical" href="https://st4lk.github.io/blog/2015/01/31/tornado-internationalization-and-localization.html" />
<meta property="og:url" content="https://st4lk.github.io/blog/2015/01/31/tornado-internationalization-and-localization.html" />
<meta property="og:site_name" content="Developer articles" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-01-31T18:19:43+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Tornado i18n и l10n" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2015-01-31T18:19:43+00:00","datePublished":"2015-01-31T18:19:43+00:00","description":"Star Статья о том, что такое i18n и i10n и как это реализовать в приложении на tornado. Получилось довольно много букв, но хотелось рассказать доступно обо всем процессе. Сама пошаговая инструкция - во второй половине статьи.","headline":"Tornado i18n и l10n","mainEntityOfPage":{"@type":"WebPage","@id":"https://st4lk.github.io/blog/2015/01/31/tornado-internationalization-and-localization.html"},"url":"https://st4lk.github.io/blog/2015/01/31/tornado-internationalization-and-localization.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="shortcut icon" type="image/png" href="/favicon.png">
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="/assets/css/styles.css"><link type="application/atom+xml" rel="alternate" href="https://st4lk.github.io/feed.xml" title="Developer articles" /><link type="application/atom+xml" rel="alternate" href="https://st4lk.github.io/feed.xml" title="Developer articles" /><script async defer src="https://buttons.github.io/buttons.js"></script>
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Алексей Евсеев</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          <a class="page-link" href="/blog/">Блог</a>
          <a class="page-link" href="/contact/">Контакты</a>
          <a class="page-link" style="margin-right: 0px" href="/blog/2015/01/31/tornado-internationalization-and-localization.html" ><img src="/assets/images/ru.png" /></a>
          <a class="page-link" href="/en/blog/2015/01/31/tornado-internationalization-and-localization.html" ><img src="/assets/images/en.png" /></a>
          <a class="page-link" href="/search/" ><img src="/assets/images/search.svg" /></a>
        </div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Tornado i18n и l10n</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2015-01-31T18:19:43+00:00" itemprop="datePublished">Jan 31, 2015
      </time><span style="float:right">

  <span><a href="/category/i18n/index.html">i18n</a></span>
&nbsp;

  <span><a href="/category/async/index.html">async</a></span>
&nbsp;

  <span><a href="/category/tornado/index.html">tornado</a></span>


</span>
    </p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><a class="github-button" href="https://github.com/st4lk/tornado_i18n_example" data-color-scheme="no-preference: light; light: light; dark: dark;" data-size="large" data-show-count="true" aria-label="Star st4lk/tornado_i18n_example on GitHub">Star</a></p>

<p><a href="/blog/2015/01/31/tornado-internationalization-and-localization.html"><img src="https://img-fotki.yandex.ru/get/4/85893628.c67/0_1715c7_738478c6_orig.png" alt="Tornado i18n и l10n" title="Tornado i18n и l10n" /></a></p>

<p>Статья о том, что такое i18n и i10n и как это реализовать в приложении на <a href="http://www.tornadoweb.org/en/stable/">tornado</a>. Получилось довольно много букв, но хотелось рассказать доступно обо всем процессе. Сама пошаговая инструкция - во второй половине статьи.</p>

<!--more-->

<h2 id="общие-определения">Общие определения</h2>

<h4 id="i18n">i18n</h4>

<p>i18n - сокращение от internationalization. Так называют процесс поддержки разных языков в приложении. Это не сам перевод, а именно техническая составляющая проекта, которая позволяет отображать текст на разных языках, в зависимости от предпочтений пользователя. Обычно реализацией занимается разработчик.</p>

<h4 id="l10n">l10n</h4>

<p>l10n - сокращение от localization. Означает сам процесс перевода текста на нужные языки. Обычно реализацией занимается переводчик.</p>

<h4 id="языковые-теги-language-tags">Языковые теги (language tags)</h4>

<p>Языковые теги (<a href="http://www.w3.org/International/articles/language-tags/">language tags</a>) указывают язык текста. Формат тегов содержит много нюансов, все они определены в <a href="http://www.rfc-editor.org/rfc/rfc5646.txt">rfc5646</a>.
Но наиболее часто встречающийся такой:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>en-US
</code></pre></div></div>

<p>Первая часть означает язык, вторая - регион применения. В данном случае тег <code class="language-plaintext highlighter-rouge">en-US</code> означает английский язык, которым пользуются в США. А скажем <code class="language-plaintext highlighter-rouge">en-GB</code> будет означать ангийский, которым пользуются в Англии (я полагаю, эти языки имеют небольшие различия). В языковом теге только одна часть обязательная - это язык. Т.е. это абсолютно нормальный тег:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>en
</code></pre></div></div>

<p>Более того, когда нет особой надобности указывать регион - не указывайте его.</p>

<h4 id="cldr">CLDR</h4>

<p><a href="http://cldr.unicode.org/">CLDR</a> - Common Locale Data Repository (общее хранилище языковых данных).  <br />
Содержит часто используемые данные на разных языках:</p>

<ul>
  <li>формат даты, цены в разных валютах, временных зон</li>
  <li>название стран, дней недели, месяцев</li>
  <li>правила написания чисел, формат множественного числа, направление письма, первый день недели</li>
  <li>и много всего другого</li>
</ul>

<h2 id="gettext">gettext<a name="gettext"></a></h2>
<p><a href="https://www.gnu.org/software/gettext/">gettext</a> - библиотека для реализации процесса i18n. В этой статье описывается работа именно с ней.</p>

<p>Tornado поддерживает так же работу и с <a href="http://www.tornadoweb.org/en/stable/locale.html#tornado.locale.load_translations">CSV файлам</a>, но этот способ имеет гораздо меньше возможностей, поэтому его рассматривать не будем.</p>

<h4 id="краткий-принцип-работы-с-gettext">Краткий принцип работы с gettext</h4>
<ol>
  <li>Все текстовые строки в коде пишем на английском.</li>
  <li>Все строки подставляем в виде аргумента одной из специальных функций, реализованных в gettext. Обычно в python’е для такого случая используют функцию с именем <code class="language-plaintext highlighter-rouge">_</code>.  <br />
 Было:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="s2">"Hello world!"</span>
</code></pre></div>    </div>
    <p>Стало:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> _<span class="o">(</span><span class="s2">"Hello world!"</span><span class="o">)</span>
</code></pre></div>    </div>
  </li>
  <li>Создаем шаблонный файл <code class="language-plaintext highlighter-rouge">.pot</code> для перевода текста.  <br />
 Это делается с помощью команды <a href="https://www.gnu.org/software/gettext/manual/html_node/xgettext-Invocation.html#xgettext-Invocation">xgettext</a>. Она парсит указанные файлы, находит в них вызов той самой функции <code class="language-plaintext highlighter-rouge">_</code> и генерирует файл <em>messages.pot</em>.  <br />
 В этом файле, помимо некоторых служебных данных (заголовков), будут содержаться строки, требующие перевода:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> msgid <span class="s2">"Hello world!"</span>
 msgstr <span class="s2">""</span>
</code></pre></div>    </div>
    <p>Этот файл не нужно редактировать, пусть он всегда будет таким. В принципе, особой нужды в этом файле нет, непосредственно в переводе он не задействован. Например скрипты django для перевода его нигде не сохраняют. Но все же лучше оставить, ведь его всегда можно дать переводчику, чтобы он мог оценить объем работы.</p>
  </li>
  <li>
    <p>Создаем файл перевода на конкретном языке.</p>

    <p>Для этого воспользуемся командой <a href="https://www.gnu.org/software/gettext/manual/html_node/msginit-Invocation.html">msginit</a>, которая из шаблона <em>messages.pot</em> создаст новый файл <em>messages.po</em>. По сути, это будет копия нашего шаблона, за исключением некоторых частей, специфичных для выбранного языка.</p>
  </li>
  <li>
    <p>Переводим строки в нашем новом <em>messages.po</em>, а так же заполняем заголовки нашими данными. Перевод будет выглядеть так:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> msgid <span class="s2">"Hello world!"</span>
 msgstr <span class="s2">"Привет, мир!"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Компилируем перевод командой <a href="https://www.gnu.org/software/gettext/manual/html_node/msgfmt-Invocation.html">msgfmt</a>. На выходе получаем <em>messages.mo</em>.</p>
  </li>
  <li>
    <p>Если где-то в коде добавились строки, которые нужно переводить, то следует лишь обновить <em>messages.po</em>, а не создавать его заново.</p>

    <p>Таким образом старые переводы сохранятся. Для этого:</p>
    <ul>
      <li>опять создаем шаблон <em>.pot</em> (пункт 3). Да, это перезатрет предыдущий <em>messages.pot</em>, но это не страшно, ведь мы там ничего не меняем сами</li>
      <li>используем команду <a href="https://www.gnu.org/software/gettext/manual/html_node/msgmerge-Invocation.html">msgmerge</a>, которая синхронизирует файлы <em>.po</em> и <em>.pot</em></li>
      <li>повторяем пункты 5 и 6.</li>
    </ul>
  </li>
</ol>

<p>Все, если функция <code class="language-plaintext highlighter-rouge">_</code> в нашем проекте работает правильно, то англичанин увидит текст “Hello world!”, а русский - “Привет, мир!”.</p>

<p>Пока осталось неясным, что из себя представляет эта самая функция <code class="language-plaintext highlighter-rouge">_</code> и откуда ее взять. Так же, как мы определим предпочитаемый язык пользователя, кто он - англичанин или русский? И где взять эти команды <code class="language-plaintext highlighter-rouge">xgettext</code>, <code class="language-plaintext highlighter-rouge">msginit</code>, <code class="language-plaintext highlighter-rouge">msgmerge</code>, <code class="language-plaintext highlighter-rouge">msgfmt</code>?</p>

<p>По порядку.</p>

<h4 id="функция-_">Функция <code class="language-plaintext highlighter-rouge">_</code></h4>

<p>Эту функцию можно написать самому, ведь в python уже встроена работа с <a href="https://docs.python.org/2/library/gettext.html">gettext</a>. Однако, в tornado и в django она уже определена. Надо лишь задать ей это имя. В django это выглядит так:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">ugettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="n">_</span><span class="p">(</span><span class="s">"Hello world!"</span><span class="p">)</span>
</code></pre></div></div>

<p>А в  tornado примерно так:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SomeHandler</span><span class="p">(</span><span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">translate</span>
        <span class="n">_</span><span class="p">(</span><span class="s">"Hello world!"</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="как-функция-_-определяет-предпочитаемый-язык-пользователя">Как функция <code class="language-plaintext highlighter-rouge">_</code> определяет предпочитаемый язык пользователя?</h4>

<p>В самом простом случае в веб приложении язык узнают из HTTP заголовка Accept-Language (предпочитаемый язык задается в настройках браузера). И в django и в tornado это уже реализовано.  <br />
Для более сложной логики, когда например пользователь сам может задать нужный ему язык в настройках своего профиля на сайте, в обоих фреймворках есть соответствующие средства. <br />
Да, в отличие от django, tornado из коробки не умеет определять язык из префикса в url. Т.е. при правильной настройке django, запрос вида <code class="language-plaintext highlighter-rouge">/ru/.../</code> отобразит русский язык, а <code class="language-plaintext highlighter-rouge">/en/.../</code> - английский. Но tornado так не умеет, его этому нужно обучать вручную.</p>

<h4 id="где-взять-команды-xgettext-msginit-msgmerge-msgfmt">Где взять команды <code class="language-plaintext highlighter-rouge">xgettext</code>, <code class="language-plaintext highlighter-rouge">msginit</code>, <code class="language-plaintext highlighter-rouge">msgmerge</code>, <code class="language-plaintext highlighter-rouge">msgfmt</code></h4>
<p>Их нужно установить.</p>

<p>В некоторых версиях Ubuntu они доступны из коробки. Установить можно так:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>gettext
</code></pre></div></div>

<p>На OSX:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew <span class="nb">install </span>gettext
brew <span class="nb">link </span>gettext <span class="nt">--force</span>
</code></pre></div></div>

<p>Для windows бинарники можно скачать отсюда (не проверял):  <a href="http://gnuwin32.sourceforge.net/packages/gettext.htm">http://gnuwin32.sourceforge.net/packages/gettext.htm</a></p>

<p>Если устанавливать не хочется или нет возможности, то можно воспользоваться встроенными в python командами: <a href="https://docs.python.org/2/library/gettext.html#internationalizing-your-programs-and-modules"><code class="language-plaintext highlighter-rouge">pygettext.py</code>, <code class="language-plaintext highlighter-rouge">msgfmt.py</code></a>. Но у них гораздо меньше возможностей, чем у xgettext. К тому же нет msgmerge, который крайне удобен.</p>

<p>Есть еще одно решение - библиотека <a href="http://babel.pocoo.org/">babel</a>. Она поддерживает многие функции xgettext, включая msgmerge. При этом не требует установленной xgettext, чистый питон. Расскажу о ней чуть позже.</p>

<h2 id="отличия-tornado-от-django">Отличия tornado от django</h2>

<p>Прежде чем приступать к инструкции по реализации i18n в tornado, хочу отметить одну особенность.  <br />
Она крайне важна для понимания работы tornado в целом.</p>

<p>Основное отличие tornado от django состоит в том, что tornado выполняется в одном процессе, а django - нет. Как это влияет на перевод строк?  <br />
В django мы можем задать переводимые строки где угодно, хоть в моделях. Для этого в django есть понятие “ленивого” перевода, например <a href="https://docs.djangoproject.com/en/dev/topics/i18n/translation/#working-with-lazy-translation-objects">ugettext_lazy</a>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">ugettext_lazy</span> <span class="k">as</span> <span class="n">_</span>

<span class="k">class</span> <span class="nc">SomeModel</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"Title"</span><span class="p">),</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</code></pre></div></div>

<p>Функция <code class="language-plaintext highlighter-rouge">ugettext_lazy</code> возвращает строку не сразу, а в момент непосредственного обращения к ней. Только в тот момент, когда предпочитаемый язык уже будет определен. Но откуда она все-таки узнает этот язык?  <br />
Очевидно, что первоначально клиент должен сделать какой-то запрос, из которого мы узнаем информацию о посетителе и определим его локализацию. В этот момент django сохранит найденный язык (с помощью функции <a href="https://docs.djangoproject.com/en/dev/ref/utils/#django.utils.translation.activate">activate()</a>) в глобальную переменную для данного потока (thread). Напомню, что для обработки каждого запроса в django создается отдельный изолированный поток.  <br />
Вот почему функция <code class="language-plaintext highlighter-rouge">ugettext_lazy</code> может быть использована где угодно, она отобразит текст на верном языке. Ей не нужно передавать никакие данные о запросе, их она узнает из глобальной переменной.</p>

<p>А в tornado так не получится, потому что тут нет изолированных потоков, поток всегда один. В этом и фишка асинхронности.  <br />
Что может получится, если мы попытаемся реализовать “ленивый” перевод в tornado?  <br />
Давайте рассмотрим простейший проект на tornado. Для реализации “ленивости” воспользуемся пакетом <a href="https://pypi.python.org/pypi/speaklater">speaklater</a>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">local</span>
<span class="kn">import</span> <span class="nn">tornado.web</span>
<span class="kn">from</span> <span class="nn">speaklater</span> <span class="kn">import</span> <span class="n">make_lazy_gettext</span>

<span class="n">_active</span> <span class="o">=</span> <span class="n">local</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">activate</span><span class="p">(</span><span class="n">current_locale</span><span class="p">):</span>
    <span class="n">_active</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">current_locale</span>

<span class="k">def</span> <span class="nf">gettext</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_active</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">translate</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="n">_</span> <span class="o">=</span> <span class="n">make_lazy_gettext</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">gettext</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">HiModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">hello</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">"Hello, world!"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">DoneModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">done</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">"Fuh, done"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">HomeHandler</span><span class="p">(</span><span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HomeHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">prepare</span><span class="p">()</span>
        <span class="n">activate</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">locale</span><span class="p">)</span>  <span class="c1"># set globally locale from request
</span>
    <span class="o">@</span><span class="n">tornado</span><span class="p">.</span><span class="n">gen</span><span class="p">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">hello_model</span> <span class="o">=</span> <span class="n">HiModel</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">hello_model</span><span class="p">.</span><span class="n">hello</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"&lt;br/&gt;"</span><span class="p">)</span>
        <span class="n">done_model</span> <span class="o">=</span> <span class="n">DoneModel</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">done_model</span><span class="p">.</span><span class="n">done</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"&lt;br/&gt;"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">finish</span><span class="p">()</span>


<span class="n">application</span> <span class="o">=</span> <span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">Application</span><span class="p">([</span>
    <span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s">"/"</span><span class="p">,</span> <span class="n">HomeHandler</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'home'</span><span class="p">),</span>
<span class="p">])</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">application</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">8888</span><span class="p">)</span>
    <span class="n">project_folder</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
    <span class="n">tornado</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">load_gettext_translations</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_folder</span><span class="p">,</span> <span class="s">'locale'</span><span class="p">),</span> <span class="s">'messages'</span><span class="p">)</span>
    <span class="n">tornado</span><span class="p">.</span><span class="n">ioloop</span><span class="p">.</span><span class="n">IOLoop</span><span class="p">.</span><span class="n">instance</span><span class="p">().</span><span class="n">start</span><span class="p">()</span>
</code></pre></div></div>

<p>Тут <code class="language-plaintext highlighter-rouge">HiModel</code> и <code class="language-plaintext highlighter-rouge">DoneModel</code> подразумевают какие-то модели, неважно какие. Главное, что у них есть переводимые строки.  <br />
Файл перевода выглядит примерно так:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msgid <span class="s2">"Hello, world!"</span>
msgstr <span class="s2">"Привет, мир!"</span>

msgid <span class="s2">"Fuh, done"</span>
msgstr <span class="s2">"Фух, вроде готово"</span>
</code></pre></div></div>

<p>Запустим наш маленький сервер.  <br />
Условимся, что в браузере “browser_en” в настройках стоит английский язык, а в браузере “browser_ru” - русский.</p>

<p>Откроем адрес <a href="http://127.0.0.1:8888/">http://127.0.0.1:8888/</a> в browser_ru и увидим:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Привет, мир!
Фух, вроде готово
</code></pre></div></div>
<p>То же самое в browser_en:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hello, world!
Fuh, done
</code></pre></div></div>

<p>Вроде все работает правильно. Но попробуем добавить асинхронную задачу. Для простоты воспользуемся <a href="http://tornado.readthedocs.org/en/latest/ioloop.html#tornado.ioloop.IOLoop.add_timeout">асинхронным таймером</a>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">tornado</span><span class="p">.</span><span class="n">gen</span><span class="p">.</span><span class="n">coroutine</span>
<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">hello_model</span> <span class="o">=</span> <span class="n">HiModel</span><span class="p">()</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">hello_model</span><span class="p">.</span><span class="n">hello</span><span class="p">))</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"&lt;br/&gt;"</span><span class="p">)</span>
    <span class="n">io_loop</span> <span class="o">=</span> <span class="n">tornado</span><span class="p">.</span><span class="n">ioloop</span><span class="p">.</span><span class="n">IOLoop</span><span class="p">.</span><span class="n">instance</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">tornado</span><span class="p">.</span><span class="n">gen</span><span class="p">.</span><span class="n">Task</span><span class="p">(</span><span class="n">io_loop</span><span class="p">.</span><span class="n">add_timeout</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">done_model</span> <span class="o">=</span> <span class="n">DoneModel</span><span class="p">()</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">done_model</span><span class="p">.</span><span class="n">done</span><span class="p">))</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"&lt;br/&gt;"</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">finish</span><span class="p">()</span>
</code></pre></div></div>

<p>Т.е. мы просто добавили эти строки:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">io_loop</span> <span class="o">=</span> <span class="n">tornado</span><span class="p">.</span><span class="n">ioloop</span><span class="p">.</span><span class="n">IOLoop</span><span class="p">.</span><span class="n">instance</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">tornado</span><span class="p">.</span><span class="n">gen</span><span class="p">.</span><span class="n">Task</span><span class="p">(</span><span class="n">io_loop</span><span class="p">.</span><span class="n">add_timeout</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
</code></pre></div></div>

<p>между работой с <code class="language-plaintext highlighter-rouge">HiModel</code> и <code class="language-plaintext highlighter-rouge">DoneModel</code>.  <br />
А теперь попробуем зайти из browser_ru и сразу, не дожидаясь окончания таймера, из browser_en.</p>

<p>В browser_ru мы увидим это:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Привет, мир!
Fuh, done
</code></pre></div></div>

<p>а в browser_en:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hello, world!
Fuh, done
</code></pre></div></div>

<p>Думаю вы уже догадались, почему в browser_ru мы видим часть текста на русском, а часть - на английском. На всякий случай давайте разберемся.</p>

<p>В момент, когда было обращение из browser_ru, мы выставили глобально русский язык.  <br />
Потом пошла асинхронная задача.  <br />
Дальше пришел другой запрос (browser_en), который выставил глобально английский язык.  <br />
После чего асинхронная команда из первого запроса завершилась и обработчик продолжил работу. Но язык уже поменялся другим обработчиком, и строка “Fuh, done” не перевелась.</p>

<p>Из всего этого можно сделать вывод, что в tornado определить язык можно только в контексте запроса  (handler), и никак иначе.</p>

<h2 id="реализация-i18n-в-tornado-с-помощью-xgettext-">Реализация i18n в tornado с помощью xgettext <a name="tornado-i18n-xgettext"></a></h2>

<p>В <a href="http://www.tornadoweb.org/en/stable/locale.html#module-tornado.locale">документации tornado</a> процесс i18n описан довольно скудно, поэтому здесь хочу описать прям по шагам, что и как нужно делать.</p>

<p>По-моему, лучше всего объяснять на конкретном примере. Поэтому давайте создадим простейший проект на tornado.</p>

<p>Структура проекта элементарная:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>└── project
    ├── app.py
    ├── home.html
    └── requirements.txt
</code></pre></div></div>

<p>app.py:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">tornado.ioloop</span>
<span class="kn">import</span> <span class="nn">tornado.web</span>

<span class="k">class</span> <span class="nc">HomeHandler</span><span class="p">(</span><span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="s">"home.html"</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Hello, world!"</span><span class="p">)</span>

<span class="n">application</span> <span class="o">=</span> <span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">Application</span><span class="p">([</span>
    <span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s">"/"</span><span class="p">,</span> <span class="n">HomeHandler</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'home'</span><span class="p">),</span>
<span class="p">])</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">application</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">8888</span><span class="p">)</span>
    <span class="n">tornado</span><span class="p">.</span><span class="n">ioloop</span><span class="p">.</span><span class="n">IOLoop</span><span class="p">.</span><span class="n">instance</span><span class="p">().</span><span class="n">start</span><span class="p">()</span>
</code></pre></div></div>

<p>home.html:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
   <span class="nt">&lt;head&gt;&lt;title&gt;</span>Home page<span class="nt">&lt;/title&gt;&lt;/head&gt;</span>
   <span class="nt">&lt;body&gt;</span>
     <span class="nt">&lt;div&gt;</span>Home page<span class="nt">&lt;/div&gt;</span>
     <span class="nt">&lt;div&gt;</span>{{text}}<span class="nt">&lt;/div&gt;</span>
   <span class="nt">&lt;/body&gt;</span>
 <span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>requirements.txt:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">tornado</span><span class="o">==</span>4.0.2
</code></pre></div></div>

<h4 id="цель">Цель</h4>

<p>Добавить в проект поддержку двух языков: английского и русского. Если у пользователя в браузере предпочитаемый язык английский - показывать текст на английском, если русский - то соответственно русский.</p>

<h4 id="1-весь-текст-в-коде-должен-быть-на-английском">1. Весь текст в коде должен быть на английском</h4>

<p>У нас это уже выполнено, на данный момент в проекте есть такие строки:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"Hello, world!"</span>  <span class="c"># app.py</span>
<span class="s2">"Home page"</span>    <span class="c"># home.html</span>
</code></pre></div></div>

<h4 id="2-маркируем-текст">2. Маркируем текст</h4>

<p>Первым делом нужно обозначить строки, требующие перевода (пункт 2. раздела <a href="#gettext">gettext</a>).  <br />
Как мы помним, это делается функцией <code class="language-plaintext highlighter-rouge">_</code>.   <br />
В коде обработчика ее можно получить так:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">translate</span>
</code></pre></div></div>

<p>Код хендлера (файл app.py):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">HomeHandler</span><span class="p">(</span><span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">translate</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="s">"home.html"</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">"Hello, world!"</span><span class="p">))</span>
</code></pre></div></div>

<p>В шаблоне эта функция уже доступна, она определена в методе <a href="https://github.com/tornadoweb/tornado/blob/branch4.0/tornado/web.py#L788">get_template_namespace()</a>.  <br />
Код шаблона (файл home.html):</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
   <span class="nt">&lt;head&gt;&lt;title&gt;</span>{{_("Home page")}}<span class="nt">&lt;/title&gt;&lt;/head&gt;</span>
   <span class="nt">&lt;body&gt;</span>
     <span class="nt">&lt;div&gt;</span>{{_("Home page")}}<span class="nt">&lt;/div&gt;</span>
     <span class="nt">&lt;div&gt;</span>{{text}}<span class="nt">&lt;/div&gt;</span>
   <span class="nt">&lt;/body&gt;</span>
 <span class="nt">&lt;/html&gt;</span>
}
</code></pre></div></div>

<p>Шаблонизатор tornado выполняет python код, который заключен внутри двойных фигурных скобок <code class="language-plaintext highlighter-rouge">{{ ... }}</code>.</p>

<h4 id="3-создаем-файл-перевода">3. Создаем файл перевода</h4>

<p>Сперва создадим папку locale в корне нашего проекта:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>locale
</code></pre></div></div>

<p>Далее создаем файлик <code class="language-plaintext highlighter-rouge">makemessages.sh</code> в корне проекта и кладем туда такой bash код:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash </span>
<span class="c"># get arguments and init variables</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"$#"</span> <span class="nt">-lt</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"Usage: </span><span class="nv">$0</span><span class="s2"> &lt;locale&gt; [optional: &lt;domain_name&gt;]"</span>
    <span class="nb">exit </span>1
<span class="k">fi
</span><span class="nv">locale</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">domain</span><span class="o">=</span><span class="s2">"messages"</span>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nv">domain</span><span class="o">=</span><span class="nv">$2</span>
<span class="k">fi
</span><span class="nv">locale_dir</span><span class="o">=</span><span class="s2">"locale/</span><span class="k">${</span><span class="nv">locale</span><span class="k">}</span><span class="s2">/LC_MESSAGES"</span>
<span class="nv">pot_file</span><span class="o">=</span><span class="s2">"locale/</span><span class="k">${</span><span class="nv">domain</span><span class="k">}</span><span class="s2">.pot"</span>
<span class="nv">po_file</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">locale_dir</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">domain</span><span class="k">}</span><span class="s2">.po"</span>
<span class="c"># create folders if not exists</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$locale_dir</span>
<span class="c"># create .pot file</span>
find <span class="nb">.</span> <span class="nt">-iname</span> <span class="s2">"*.html"</span> <span class="nt">-o</span> <span class="nt">-iname</span> <span class="s2">"*.py"</span> | xargs <span class="se">\</span>
    xgettext <span class="nt">--output</span><span class="o">=</span><span class="k">${</span><span class="nv">pot_file</span><span class="k">}</span> <span class="nt">--language</span><span class="o">=</span>Python <span class="nt">--from-code</span><span class="o">=</span>UTF-8 <span class="se">\</span>
    <span class="nt">--sort-by-file</span> <span class="nt">--keyword</span><span class="o">=</span>_ <span class="nt">--keyword</span><span class="o">=</span>_:1,2 <span class="nt">--no-wrap</span>
<span class="c"># init .po file, if it doesn't exist yet</span>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="nv">$po_file</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span>msginit <span class="nt">--input</span><span class="o">=</span><span class="k">${</span><span class="nv">pot_file</span><span class="k">}</span> <span class="nt">--output-file</span><span class="o">=</span><span class="k">${</span><span class="nv">po_file</span><span class="k">}</span> <span class="nt">--no-wrap</span> <span class="nt">--locale</span><span class="o">=</span><span class="k">${</span><span class="nv">locale</span><span class="k">}</span>
<span class="k">else</span>
    <span class="c"># update .po file</span>
    msgmerge <span class="nt">--no-wrap</span> <span class="nt">--sort-by-file</span> <span class="nt">--output-file</span><span class="o">=</span><span class="k">${</span><span class="nv">po_file</span><span class="k">}</span> <span class="k">${</span><span class="nv">po_file</span><span class="k">}</span> <span class="k">${</span><span class="nv">pot_file</span><span class="k">}</span>
<span class="k">fi</span>
</code></pre></div></div>

<p>Даем права на запуск:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chmod </span>a+x makemessages.sh
</code></pre></div></div>

<p>При запуске нужно указать языковой тег. Для этого языка мы будем делать перевод, в данном примере это русский:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./makemessages.sh ru
</code></pre></div></div>

<p>При первом запуске может потребоваться ввести ваш email. <br />
После выполнения появятся файлы <em>messages.pot</em> и <em>messages.po</em>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>project
├── locale
│   ├── ru
│   │   └── LC_MESSAGES
│   │       └── messages.po
│   └── messages.pot
├── app.py
├── home.html
├── requirements.txt
└── makemessages.sh
</code></pre></div></div>

<p>Содержимое messages.po:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Russian translations for tornado_i18n package.</span>
<span class="c"># Copyright (C) 2015 THE tornado_i18n'S COPYRIGHT HOLDER</span>
<span class="c"># This file is distributed under the same license as the tornado_i18n package.</span>
<span class="c"># stalk &lt;alexevseev@gmail.com&gt;, 2015.</span>
<span class="c">#</span>
msgid <span class="s2">""</span>
msgstr <span class="s2">""</span>
<span class="s2">"Project-Id-Version: tornado_i18n</span><span class="se">\n</span><span class="s2">"</span>
<span class="s2">"Report-Msgid-Bugs-To: </span><span class="se">\n</span><span class="s2">"</span>
<span class="s2">"POT-Creation-Date: 2015-01-30 12:27+0300</span><span class="se">\n</span><span class="s2">"</span>
<span class="s2">"PO-Revision-Date: 2015-01-30 12:27+0300</span><span class="se">\n</span><span class="s2">"</span>
<span class="s2">"Last-Translator: stalk &lt;alexevseev@gmail.com&gt;</span><span class="se">\n</span><span class="s2">"</span>
<span class="s2">"Language-Team: Russian</span><span class="se">\n</span><span class="s2">"</span>
<span class="s2">"Language: ru</span><span class="se">\n</span><span class="s2">"</span>
<span class="s2">"MIME-Version: 1.0</span><span class="se">\n</span><span class="s2">"</span>
<span class="s2">"Content-Type: text/plain; charset=ASCII</span><span class="se">\n</span><span class="s2">"</span>
<span class="s2">"Content-Transfer-Encoding: 8bit</span><span class="se">\n</span><span class="s2">"</span>
<span class="s2">"Plural-Forms: nplurals=3; plural=(n%10==1 &amp;&amp; n%100!=11 ? 0 : n%10&gt;=2 &amp;&amp; n%10&lt;=4 &amp;&amp; (n%100&lt;10 || n%100&gt;=20) ? 1 : 2);</span><span class="se">\n</span><span class="s2">"</span>

<span class="c">#: app.py:8</span>
msgid <span class="s2">"Hello, world!"</span>
msgstr <span class="s2">""</span>

<span class="c">#: home.html:2 home.html:4</span>
msgid <span class="s2">"Home page"</span>
msgstr <span class="s2">""</span>
</code></pre></div></div>

<p>Здесь нужно <strong>обязательно</strong> поменять charset=ASCII на charset=UTF-8, остальные заголовки - опционально:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"Content-Type: text/plain; charset=UTF-8\n"
</code></pre></div></div>

<h4 id="4-переводим">4. Переводим</h4>

<p>Заполняем пустые строки вида msgstr “” в <em>messages.po</em> (не <em>.pot</em>!):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#: app.py:8</span>
msgid <span class="s2">"Hello, world!"</span>
msgstr <span class="s2">"Привет, мир!"</span>

<span class="c">#: home.html:2 home.html:4</span>
msgid <span class="s2">"Home page"</span>
msgstr <span class="s2">"Домашняя страница"</span>
</code></pre></div></div>

<h4 id="5-компилируем-перевод">5. Компилируем перевод</h4>

<p>Создаем файлик <code class="language-plaintext highlighter-rouge">compilemessages.sh</code> с кодом:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash </span>
<span class="c"># get arguments and init variables</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"$#"</span> <span class="nt">-lt</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"Usage: </span><span class="nv">$0</span><span class="s2"> &lt;locale&gt; [optional: &lt;domain_name&gt;]"</span>
    <span class="nb">exit </span>1
<span class="k">fi
</span><span class="nv">locale</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">domain</span><span class="o">=</span><span class="s2">"messages"</span>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nv">domain</span><span class="o">=</span><span class="nv">$2</span>
<span class="k">fi
</span><span class="nv">locale_dir</span><span class="o">=</span><span class="s2">"locale/</span><span class="k">${</span><span class="nv">locale</span><span class="k">}</span><span class="s2">/LC_MESSAGES"</span>
<span class="nv">po_file</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">locale_dir</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">domain</span><span class="k">}</span><span class="s2">.po"</span>
<span class="nv">mo_file</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">locale_dir</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">domain</span><span class="k">}</span><span class="s2">.mo"</span>
<span class="c"># create .mo file from .po</span>
msgfmt <span class="k">${</span><span class="nv">po_file</span><span class="k">}</span> <span class="nt">--output-file</span><span class="o">=</span><span class="k">${</span><span class="nv">mo_file</span><span class="k">}</span>
</code></pre></div></div>

<p>Даем права на запуск:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chmod </span>a+x compilemessages.sh
</code></pre></div></div>

<p>При запуске указываем тот же языковой тег, что и для <em>makemessages.sh</em>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./compilemessages.sh ru
</code></pre></div></div>

<p>Получился файл <em>locale/ru/LC_MESSAGES/messages.mo</em>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>project
├── locale
│   ├── ru
│   │   └── LC_MESSAGES
│   │       ├── messages.po
│   │       └── messages.mo
│   └── messages.pot
├── app.py
├── home.html
├── requirements.txt
├── compilemessages.sh
└── makemessages.sh
</code></pre></div></div>

<h4 id="6-связываем-перевод-с-нашим-проектом">6. Связываем перевод с нашим проектом</h4>

<p>Для этого вызываем функцию <a href="http://www.tornadoweb.org/en/stable/locale.html#tornado.locale.load_gettext_translations">load_gettext_translations()</a>.</p>

<p>app.py:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">tornado</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">load_gettext_translations</span><span class="p">(</span><span class="s">'locale'</span><span class="p">,</span> <span class="s">'messages'</span><span class="p">)</span>
    <span class="n">application</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">8888</span><span class="p">)</span>
    <span class="n">tornado</span><span class="p">.</span><span class="n">ioloop</span><span class="p">.</span><span class="n">IOLoop</span><span class="p">.</span><span class="n">instance</span><span class="p">().</span><span class="n">start</span><span class="p">()</span>
</code></pre></div></div>

<p>Попробуем запустить проект.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python app.py
</code></pre></div></div>

<p>Откроем в browser_en адрес <a href="http://127.0.0.1:8888/">http://127.0.0.1:8888/</a>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Home page
Hello, world!
</code></pre></div></div>

<p>и brower_ru:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Домашняя страница
Привет, мир!
</code></pre></div></div>

<p>Вот и все, перевод готов!</p>

<h4 id="7-обновление-перевода">7. Обновление перевода</h4>

<p>Допустим, в файле home.html у нас добавился текст, который нужно перевести:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div&gt;</span>{{_("Good buy!")}}<span class="nt">&lt;/div&gt;</span>
}
</code></pre></div></div>

<p>В этом случае мы просто выполняем наш скрипт:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./makemessages.sh ru
</code></pre></div></div>

<p>заполняем перевод в обновленном <em>messages.po</em>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#: home.html:6</span>
msgid <span class="s2">"Good buy!"</span>
msgstr <span class="s2">"До свидания!"</span>
</code></pre></div></div>

<p>компилируем:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./compilemessages.sh ru
</code></pre></div></div>

<p>и перезапускаем сервер</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python app.py
</code></pre></div></div>

<p>Все!</p>

<h4 id="8-множественные-значения">8. Множественные значения</h4>

<p>gettext поддерживает множественные значения (plural forms). Вот как это выглядит:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ngettext<span class="o">(</span><span class="s2">"{count} event is gonna happen"</span>, <span class="s2">"{count} events are gonna happen"</span>, count<span class="o">)</span>.format<span class="o">(</span><span class="nv">count</span><span class="o">=</span>count<span class="o">)</span>
</code></pre></div></div>

<p>ngettext - стандартное имя функции для множественных форм, которое используется в gettext.  <br />
Но в tornado функция <code class="language-plaintext highlighter-rouge">self.locale.translate</code>, которую мы назвали как <code class="language-plaintext highlighter-rouge">_</code>, так же поддерживает аргументы ngettext. Вообщем, мы можем вместо ngettext использовать привычный нам <code class="language-plaintext highlighter-rouge">_</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_</span><span class="p">(</span><span class="s">"{count} event is gonna happen"</span><span class="p">,</span> <span class="s">"{count} events are gonna happen"</span><span class="p">,</span> <span class="n">count</span><span class="p">).</span><span class="nb">format</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>
</code></pre></div></div>

<p>Обратите внимание на аргументы функции xgettext в нашем скрипте выше:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">--keyword</span><span class="o">=</span>_ <span class="nt">--keyword</span><span class="o">=</span>_:1,2
</code></pre></div></div>

<p>Так мы указываем для парсера, что функция <code class="language-plaintext highlighter-rouge">_</code> может принимать как одну строку, так и две вместе с числом.</p>

<p>Смысл этого в том, что в зависимости от значения <code class="language-plaintext highlighter-rouge">count</code> строка будет принимать либо множественное значение, либо единичное.  <br />
В случае английского языка это будет выглядеть так:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_</span><span class="p">(</span><span class="s">"{count} event is gonna happen"</span><span class="p">,</span> <span class="s">"{count} events are gonna happen"</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nb">format</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># вывод
</span><span class="s">"1 event is gonna happen"</span>

<span class="n">_</span><span class="p">(</span><span class="s">"{count} event is gonna happen"</span><span class="p">,</span> <span class="s">"{count} events are gonna happen"</span><span class="p">,</span> <span class="mi">2</span><span class="p">).</span><span class="nb">format</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># вывод
</span><span class="s">"2 events are gonna happen"</span>
</code></pre></div></div>

<p>Как мы видим, у английского языка только 1 форма множественного числа. Т.е. всегда, когда <code class="language-plaintext highlighter-rouge">count &gt; 1</code>, вывод будет один и тот же.</p>

<p>Однако в русском языке может быть 3 формы (а в некоторых других языках и того больше). Давайте попробуем перевести вручную эту строку:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1,21,31 событие должно случиться
2,3,4,22 события должно случиться
5,6,7,8,9,20,25 событий должно случиться
</code></pre></div></div>

<p>Если мы все сделаем правильно, gettext будет выводить верную форму.</p>

<p>Реализуем это в нашем примере.  <br />
Добавим в шаблон home.html такую строку:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div&gt;</span>{{_("{count} event is gonna happen", "{count} events are gonna happen", count).format(count=count)}}<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>а в обработчик из файла app.py:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">HomeHandler</span><span class="p">(</span><span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">translate</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">'count'</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="s">"home.html"</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">"Hello, world!"</span><span class="p">),</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>
</code></pre></div></div>

<p>Обновим наш файл переводов:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./makemessages.sh ru
</code></pre></div></div>

<p>Видим такие строки в <em>locale/ru/LC_MESSAGES/messages.po</em>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#: home.html:6</span>
<span class="c">#, python-brace-format</span>
msgid <span class="s2">"{count} event is gonna happen"</span>
msgid_plural <span class="s2">"{count} events are gonna happen"</span>
msgstr[0] <span class="s2">""</span>
msgstr[1] <span class="s2">""</span>
msgstr[2] <span class="s2">""</span>
</code></pre></div></div>

<p>gettext сам знает, что в русском языке для множественного значения может быть 3 формы.
Обратите внимание на заголовок, который был создан командой msginit:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"Plural-Forms: nplurals=3; plural=(n%10==1 &amp;&amp; n%100!=11 ? 0 : n%10&gt;=2 &amp;&amp; n%10&lt;=4 &amp;&amp; (n%100&lt;10 || n%100&gt;=20) ? 1 : 2);</span><span class="se">\n</span><span class="s2">"</span>
</code></pre></div></div>

<p>Условия из этого заголовка и определяют нужный вариант в зависимости от числа.  <br />
Итак, добавим перевод:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#: home.html:6</span>
<span class="c">#, python-brace-format</span>
msgid <span class="s2">"{count} event is gonna happen"</span>
msgid_plural <span class="s2">"{count} events are gonna happen"</span>
msgstr[0] <span class="s2">"{count} событие должно случиться"</span>
msgstr[1] <span class="s2">"{count} события должно случиться"</span>
msgstr[2] <span class="s2">"{count} событий должно случиться"</span>
</code></pre></div></div>

<p>Скомпилируем:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./compilemessages.sh ru
</code></pre></div></div>

<p>Запустим сервер и попробуем обратиться из browser_ru</p>

<p><a href="http://127.0.0.1:8888/">http://127.0.0.1:8888/</a>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 событие должно случиться
</code></pre></div></div>

<p><a href="http://127.0.0.1:8888/?count=2">http://127.0.0.1:8888/?count=2</a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2 события должно случиться
</code></pre></div></div>

<p><a href="http://127.0.0.1:8888/?count=5">http://127.0.0.1:8888/?count=5</a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>5 событий должно случиться
</code></pre></div></div>

<p>Отлично!</p>

<h4 id="9-особая-логика-для-выбора-языка">9. Особая логика для выбора языка</h4>

<p>До сих пор язык пользователя определялся из настроек его браузера. Но допустим мы хотим, чтобы пользователь мог сам выбрать язык и сохранить его где-нибудь у себя в профиле на нашем сайте.  <br />
Логику выбора языка можно легко изменить. Если мы это сделаем, то настройки браузера уже не будут влиять.  <br />
Для этого просто нужно определить язык в методе <code class="language-plaintext highlighter-rouge">get_user_locale()</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">HomeHandler</span><span class="p">(</span><span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get_user_locale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tornado</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"ru"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">translate</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="s">"home.html"</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">"Hello, world!"</span><span class="p">))</span>
</code></pre></div></div>

<p>Теперь независимо от браузера, текст всегда будет отображаться на русском языке.</p>

<h2 id="библиотека-babel">Библиотека babel</h2>

<p>Идем дальше. <a href="http://babel.pocoo.org/">babel</a> предоставляет доступ к CLDR данным из python’а. Так же она реализует команды xgettext на python’e, т.о. xgettext можно не устанавливать. Но остановимся пока на CLDR.</p>

<p>Давайте попробуем вывести цену какого-нибудь продукта в долларах. В разных странах приняты разные способы отображения цен.  <br />
Например, в России обычно указывают цену так: 99,00 $  <br />
а в США так: $99.00  <br />
а в какой-то другой стране еще по другому.</p>

<p>И эта информация, помимо всего прочего, есть в CLDR (рубли там тоже есть :))! Мы можем легко использовать ее благодаря babel.  <br />
Установим babel:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>babel
</code></pre></div></div>

<p>Изменим app.py:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">tornado.ioloop</span>
<span class="kn">import</span> <span class="nn">tornado.web</span>
<span class="kn">from</span> <span class="nn">babel.numbers</span> <span class="kn">import</span> <span class="n">format_currency</span>


<span class="k">class</span> <span class="nc">HomeHandler</span><span class="p">(</span><span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">translate</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">'count'</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">format_usd</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">format_currency</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s">"USD"</span><span class="p">,</span>
            <span class="n">locale</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">code</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="s">"home.html"</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">"Hello, world!"</span><span class="p">),</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span>
            <span class="n">format_usd</span><span class="o">=</span><span class="n">format_usd</span><span class="p">)</span>
</code></pre></div></div>

<p>а в шаблон home.html добавим цену:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div&gt;</span>{{format_usd(99)}}<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>И все, ничего больше делать не надо.  <br />
browser_ru отобразит:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>99,00 $
</code></pre></div></div>

<p>browser_en:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$99.00
</code></pre></div></div>

<p>Это лишь одна из множества функций, доступная в babel. Там есть дни недели, месяцев, форматы даты и многое другое. И этим можно и нужно пользоваться, не стоит переводить все вручную.</p>

<h2 id="реализация-i18n-в-tornado-с-помощью-babel-">Реализация i18n в tornado с помощью babel <a name="tornado-i18n-babel"></a></h2>

<p>Как я уже говорил, в babel реализованы основные функции xgettext на python’e. Т.о. можно не устанавливать xgettext. Так же в babel есть возможность задавать свой синтаксис для парсинга. Это может быть удобно для шаблонов html, где синтаксис отличается от python.</p>

<p>Возьмем все тот же наш маленький проект. По идее, нам нужно будет лишь изменить скрипты <em>makemessages.sh</em> и <em>compilemessages.sh</em>.</p>

<p>Для чистоты эксперимента удалим все файлы внутри папки locale. Т.о. структура проекта будет такая:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>project
├── locale
├── app.py
├── home.html
├── requirements.txt
├── makemessages.sh
└── compilemessages.sh
</code></pre></div></div>

<p>Установим babel, если еще не установили:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>babel
</code></pre></div></div>

<p>Так же для парсинга шаблонов tornado нам понадобится пакет <a href="https://pypi.python.org/pypi/Tornado-Babel/">tornado-babel</a>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>tornado-babel
</code></pre></div></div>

<p>Первым делом нужно создать файл <em>locale/babel.cfg</em> с содержимым:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>python: <span class="k">**</span>.py]
<span class="o">[</span>tornado: <span class="k">**</span>.html]
</code></pre></div></div>

<p>Так мы указываем, какие файлы парсить и какой синтаксис использовать при парсинге.</p>

<p>Перепишем наш <em>makemessages.sh</em>, чтобы он вызывал команды babel вместо xgettext:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash </span>
<span class="c"># get arguments and init variables</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"$#"</span> <span class="nt">-lt</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"Usage: </span><span class="nv">$0</span><span class="s2"> &lt;locale&gt; [optional: &lt;domain_name&gt;]"</span>
    <span class="nb">exit </span>1
<span class="k">fi
</span><span class="nv">locale</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">domain</span><span class="o">=</span><span class="s2">"messages"</span>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nv">domain</span><span class="o">=</span><span class="nv">$2</span>
<span class="k">fi
</span><span class="nv">base_dir</span><span class="o">=</span><span class="s2">"locale"</span>
<span class="nv">locale_dir</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">base_dir</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">locale</span><span class="k">}</span><span class="s2">/LC_MESSAGES"</span>
<span class="nv">pot_file</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">base_dir</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">domain</span><span class="k">}</span><span class="s2">.pot"</span>
<span class="nv">po_file</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">locale_dir</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">domain</span><span class="k">}</span><span class="s2">.po"</span>
<span class="nv">babel_config</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">base_dir</span><span class="k">}</span><span class="s2">/babel.cfg"</span>
<span class="c"># create pot template</span>
pybabel extract ./ <span class="nt">--output</span><span class="o">=</span><span class="k">${</span><span class="nv">pot_file</span><span class="k">}</span> <span class="se">\</span>
    <span class="nt">--charset</span><span class="o">=</span>UTF-8 <span class="nt">--no-wrap</span> <span class="nt">--sort-by-file</span> <span class="se">\</span>
    <span class="nt">--keyword</span><span class="o">=</span>_ <span class="nt">--mapping</span><span class="o">=</span><span class="k">${</span><span class="nv">babel_config</span><span class="k">}</span>
<span class="c"># init .po file, if it doesn't exist yet</span>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="nv">$po_file</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span>pybabel init <span class="nt">--input-file</span><span class="o">=</span><span class="k">${</span><span class="nv">pot_file</span><span class="k">}</span> <span class="nt">--output-dir</span><span class="o">=</span><span class="k">${</span><span class="nv">base_dir</span><span class="k">}</span> <span class="se">\</span>
        <span class="nt">--domain</span><span class="o">=</span><span class="k">${</span><span class="nv">domain</span><span class="k">}</span> <span class="nt">--locale</span><span class="o">=</span><span class="k">${</span><span class="nv">locale</span><span class="k">}</span> <span class="nt">--no-wrap</span>
<span class="k">else</span>
    <span class="c"># update .po file</span>
    pybabel update <span class="nt">--domain</span><span class="o">=</span><span class="k">${</span><span class="nv">domain</span><span class="k">}</span> <span class="nt">--input-file</span><span class="o">=</span><span class="k">${</span><span class="nv">pot_file</span><span class="k">}</span> <span class="se">\</span>
    <span class="nt">--output-dir</span><span class="o">=</span><span class="k">${</span><span class="nv">base_dir</span><span class="k">}</span> <span class="nt">--locale</span><span class="o">=</span><span class="k">${</span><span class="nv">locale</span><span class="k">}</span> <span class="nt">--no-wrap</span>
<span class="k">fi</span>
</code></pre></div></div>

<p>А так же compilemessages.sh:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash </span>
<span class="c"># get arguments and init variables</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"$#"</span> <span class="nt">-lt</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"Usage: </span><span class="nv">$0</span><span class="s2"> &lt;locale&gt; [optional: &lt;domain_name&gt;]"</span>
    <span class="nb">exit </span>1
<span class="k">fi
</span><span class="nv">locale</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">domain</span><span class="o">=</span><span class="s2">"messages"</span>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nv">domain</span><span class="o">=</span><span class="nv">$2</span>
<span class="k">fi
</span><span class="nv">locale_dir</span><span class="o">=</span><span class="s2">"locale/</span><span class="k">${</span><span class="nv">locale</span><span class="k">}</span><span class="s2">/LC_MESSAGES"</span>
<span class="nv">po_file</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">locale_dir</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">domain</span><span class="k">}</span><span class="s2">.po"</span>
<span class="nv">mo_file</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">locale_dir</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">domain</span><span class="k">}</span><span class="s2">.mo"</span>
<span class="c"># create .mo file from .po</span>
pybabel compile <span class="nt">--locale</span><span class="o">=</span><span class="k">${</span><span class="nv">locale</span><span class="k">}</span> <span class="nt">--domain</span><span class="o">=</span><span class="k">${</span><span class="nv">domain</span><span class="k">}</span> <span class="nt">--directory</span><span class="o">=</span>locale/
</code></pre></div></div>

<p>Если вы заметили, мы указываем только <code class="language-plaintext highlighter-rouge">--keyword=_</code>. Без <code class="language-plaintext highlighter-rouge">--keyword=_:1,2</code>. Почему?  <br />
Дело в том, что в версии babel==1.3, которая доступна из pypi на момент написания статьи, не поддерживаются разные аргументы для одной и той же функции.  <br />
На что это влияет в нашем случае?  <br />
Нам придется для множественных форм использовать функцию <code class="language-plaintext highlighter-rouge">ngettext</code>, а не <code class="language-plaintext highlighter-rouge">_</code>.  <br />
Для этого поправим чуть-чуть app.py, определив <code class="language-plaintext highlighter-rouge">ngettext</code> и передав ее в шаблон:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">HomeHandler</span><span class="p">(</span><span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ngettext</span> <span class="o">=</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">translate</span>
        <span class="c1"># ...
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="s">"home.html"</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">"Hello, world!"</span><span class="p">),</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span>
            <span class="n">ngettext</span><span class="o">=</span><span class="n">ngettext</span><span class="p">)</span>
</code></pre></div></div>

<p>и в шаблоне для перевода множественных форм используем ngettext:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;div&gt;</span>{{ngettext("{count} event is gonna happen", "{count} events are gonna happen", count).format(count=count)}}<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>Дальше все по старому.</p>

<p>Создаем файлы перевода:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./makemessages.sh ru
</code></pre></div></div>

<p>Опять добавляем перевод в <em>locale/ru/LC_MESSAGES/messages.po</em>.</p>

<p>Компилируем:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./compilemessages.sh ru
</code></pre></div></div>

<p>При выполнении этого скрипта можно увидеть что-то вроде</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>catalog <span class="s1">'locale/ru/LC_MESSAGES/messages.po'</span> is marked as fuzzy, skipping
</code></pre></div></div>

<p>Тогда нужно в файле <em>messages.po</em> удалить такие строки, говорящие, что перевод не подтвержденный:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#, fuzzy</span>
</code></pre></div></div>

<p>и опять скомпилировать перевод.</p>

<p>И теперь все работает аналогично. Но без xgettext!</p>

<h4 id="исправляем-babel">Исправляем babel</h4>

<p>Согласитесь, что неудобно иметь две функции <code class="language-plaintext highlighter-rouge">_</code> и <code class="language-plaintext highlighter-rouge">ngettext</code>. Давайте это исправим! :)  <br />
Я отправил pull-request’ы в <a href="https://github.com/mitsuhiko/babel/pull/140">babel репозиторий</a> и в <a href="https://github.com/openlabs/tornado-babel/pull/6">tornado-babel</a>. Возможно, они уже приняты.  <br />
Однако, чтобы не ждать, есть готовые версии с этими исправлениями. Но вначале удалим текущие babel и tornado-babel:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip uninstall babel
pip uninstall tornado-babel
</code></pre></div></div>

<p>Ставим исправленные версии:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>https://github.com/st4lk/babel/archive/2.1.2-draft.tar.gz
pip <span class="nb">install </span>https://github.com/st4lk/tornado-babel/archive/0.3b.tar.gz
</code></pre></div></div>

<p>Добавим <code class="language-plaintext highlighter-rouge">--keyword=_1,2</code> в <em>makemessages.sh</em>.  <br />
Было:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">--keyword</span><span class="o">=</span>_ <span class="nt">--mapping</span><span class="o">=</span><span class="k">${</span><span class="nv">babel_config</span><span class="k">}</span>
</code></pre></div></div>

<p>Стало:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">--keyword</span><span class="o">=</span>_ <span class="nt">--keyword</span><span class="o">=</span>_:1,2 <span class="nt">--mapping</span><span class="o">=</span><span class="k">${</span><span class="nv">babel_config</span><span class="k">}</span>
</code></pre></div></div>

<p>Уберем теперь уже не нужную функцию ngettext.</p>

<p>app.py:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">HomeHandler</span><span class="p">(</span><span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">translate</span>
        <span class="c1"># ...
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="s">"home.html"</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">"Hello, world!"</span><span class="p">),</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>
</code></pre></div></div>

<p>home.html:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div&gt;</span>{{_("{count} event is gonna happen", "{count} events are gonna happen", count).format(count=count)}}<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>Ура, теперь мы работаем с babel точно так же, как и с xgettext!</p>

<p>Если что, код примера на github’e: <a href="https://github.com/st4lk/tornado_i18n_example">https://github.com/st4lk/tornado_i18n_example</a></p>

  </div>

  <div class="post-categories">

  <span><a href="/category/i18n/index.html">i18n</a></span>
&nbsp;

  <span><a href="/category/async/index.html">async</a></span>
&nbsp;

  <span><a href="/category/tornado/index.html">tornado</a></span>


</div><div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://st4lk.github.io/blog/2015/01/31/tornado-internationalization-and-localization.html';
      this.page.identifier = 'https://st4lk.github.io/blog/2015/01/31/tornado-internationalization-and-localization.html';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://lexev-dev.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript><a class="u-url" href="/blog/2015/01/31/tornado-internationalization-and-localization.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name"></li><li><a class="u-email" href="mailto:alexevseev@gmail.com">alexevseev@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"></div>

      <div class="footer-col footer-col-3"><ul class="social-media-list"><li><a href="https://github.com/st4lk"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">st4lk</span></a></li></ul>
</div>
    </div>

  </div>

</footer>
<script id="dsq-count-scr" src="//lexev-dev.disqus.com/count.js" async></script></body>

</html>
