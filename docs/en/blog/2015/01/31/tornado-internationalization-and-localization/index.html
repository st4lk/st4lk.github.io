<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Tornado i18n and l10n | Alexey Evseev</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Tornado i18n and l10n" />
<meta name="author" content="Alexey Evseev" />
<meta property="og:locale" content="en" />
<meta name="description" content="Star Let’s talk about i18n, i10n and tornado implementation. This post have a lot of text, but i wanted to describe many things that i faced during realization of i18n in tornado project. The step by step instruction is placed in the second part of this article." />
<meta property="og:description" content="Star Let’s talk about i18n, i10n and tornado implementation. This post have a lot of text, but i wanted to describe many things that i faced during realization of i18n in tornado project. The step by step instruction is placed in the second part of this article." />
<link rel="canonical" href="https://st4lk.github.io/en/blog/2015/01/31/tornado-internationalization-and-localization/" />
<meta property="og:url" content="https://st4lk.github.io/en/blog/2015/01/31/tornado-internationalization-and-localization/" />
<meta property="og:site_name" content="Alexey Evseev" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-01-31T18:19:43+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Tornado i18n and l10n" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Alexey Evseev"},"dateModified":"2015-01-31T18:19:43+00:00","datePublished":"2015-01-31T18:19:43+00:00","description":"Star Let’s talk about i18n, i10n and tornado implementation. This post have a lot of text, but i wanted to describe many things that i faced during realization of i18n in tornado project. The step by step instruction is placed in the second part of this article.","headline":"Tornado i18n and l10n","mainEntityOfPage":{"@type":"WebPage","@id":"https://st4lk.github.io/en/blog/2015/01/31/tornado-internationalization-and-localization/"},"url":"https://st4lk.github.io/en/blog/2015/01/31/tornado-internationalization-and-localization/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="shortcut icon" type="image/png" href="/favicon.png">
  <link rel="stylesheet" href="/en/assets/main.css">
  <link rel="stylesheet" href="/en/assets/css/styles.css"><link type="application/atom+xml" rel="alternate" href="https://st4lk.github.io/en/feed.xml" title="Alexey Evseev" /><!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8ZHLL9G1CF"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8ZHLL9G1CF');
</script>
<link rel="alternate" hreflang="ru" href="https://st4lk.github.io/blog/2015/01/31/tornado-internationalization-and-localization/" />

  <link rel="alternate" hreflang="en" href="https://st4lk.github.io/en/blog/2015/01/31/tornado-internationalization-and-localization/" />

  <script async defer src="https://buttons.github.io/buttons.js"></script>
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/en/">Alexey Evseev</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          <a class="page-link" href="/en/blog/">Blog</a>
          <a class="page-link" href="/en/contact/">Contact</a>
          <a class="page-link" style="margin-right: 0px" href="/blog/2015/01/31/tornado-internationalization-and-localization/" ><img src="/en/assets/images/ru.png" /></a>
          <a class="page-link" href="/en/blog/2015/01/31/tornado-internationalization-and-localization/" ><img src="/en/assets/images/en.png" /></a>
          <a class="page-link" href="/en/search/" ><img src="/en/assets/images/search.svg" /></a>
        </div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Tornado i18n and l10n</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2015-01-31T18:19:43+00:00" itemprop="datePublished">Jan 31, 2015
      </time><span style="float:right">

  <span><a href="/en/category/i18n/">i18n</a></span>
&nbsp;

  <span><a href="/en/category/async/">async</a></span>
&nbsp;

  <span><a href="/en/category/tornado/">tornado</a></span>


</span>
    </p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><a class="github-button" href="https://github.com/st4lk/tornado_i18n_example" data-color-scheme="no-preference: light; light: light; dark: dark;" data-size="large" data-show-count="true" aria-label="Star st4lk/tornado_i18n_example on GitHub">Star</a></p>

<p><a href="/en/blog/2015/01/31/tornado-internationalization-and-localization/"><img src="https://img-fotki.yandex.ru/get/4/85893628.c67/0_1715c7_738478c6_orig.png" alt="Tornado i18n and l10n" title="Tornado i18n and l10n" /></a></p>

<p>Let’s talk about i18n, i10n and <a href="http://www.tornadoweb.org/en/stable/">tornado</a> implementation. This post have a lot of text, but i wanted to describe many things that i faced during realization of i18n in tornado project. The step by step instruction is placed in the second part of this article.</p>

<!--more-->

<h2 id="common-definitions">Common definitions</h2>

<h4 id="i18n">i18n</h4>

<p>i18n - shorthand from internationalization. It mean the process of multiple languages support in application. It is not the translation itself, but technical part of the project, that allows to show text in different languages depending on user preferences. Usually done by developer.</p>

<h4 id="l10n">l10n</h4>

<p>l10n - shorthand from localization. It mean the translation process. Usually done by translator.</p>

<h4 id="language-tags">Language tags</h4>

<p><a href="http://www.w3.org/International/articles/language-tags/">Language tags</a> define the language. Tag format contains many nuances, all of them are described in <a href="http://www.rfc-editor.org/rfc/rfc5646.txt">rfc5646</a>.  <br />
But the most common used format is following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>en-US
</code></pre></div></div>

<p>First part define language and second - region. In current example tag <code class="language-plaintext highlighter-rouge">en-US</code> means english language, that is used in USA. And for example <code class="language-plaintext highlighter-rouge">en-GB</code> will mean english language, that is used in Great Britain (i suppose they differs a little bit). In language tag only one subtag is mandatory - language. Therefore this is correct tag:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>en
</code></pre></div></div>

<p>Moreover, if region subtag is not necessary - don’t use it.</p>

<h4 id="cldr">CLDR</h4>

<p><a href="http://cldr.unicode.org/">CLDR</a> - Common Locale Data Repository.  <br />
Contains commonly used data in different langauges:</p>

<ul>
  <li>format of date, price in different currencies, timezones</li>
  <li>country names, week days, months</li>
  <li>rules of writing numbers, plural forms, write direction, first week day</li>
  <li>and etc.</li>
</ul>

<h2 id="gettext">gettext<a name="gettext"></a></h2>
<p><a href="https://www.gnu.org/software/gettext/">gettext</a> - library that realise i18n process. In this article working with this lib is described.</p>

<p>Torando allows also working with <a href="http://www.tornadoweb.org/en/stable/locale.html#tornado.locale.load_translations">CSV files</a>, but this approach have much less features, so i’ll not describe it here.</p>

<h4 id="short-description-of-gettext-workflow">Short description of gettext workflow</h4>
<ol>
  <li>All text strings in code must be written in english.</li>
  <li>
    <p>Mark translatable strings.</p>

    <p>Put all strings as argument of special function, implemented in gettext. In python function with name <code class="language-plaintext highlighter-rouge">_</code> is usually used.
 Was:</p>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="s">"Hello world!"</span>
</code></pre></div>    </div>
    <p>Now:</p>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">_</span><span class="p">(</span><span class="s">"Hello world!"</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Create <code class="language-plaintext highlighter-rouge">.pot</code> template file.</p>

    <p>It can be done with <a href="https://www.gnu.org/software/gettext/manual/html_node/xgettext-Invocation.html#xgettext-Invocation">xgettext</a> util. It parse specified files, find calls of function <code class="language-plaintext highlighter-rouge">_</code> and generate file <em>messages.pot</em>.
 This file will contain strings to be translated, along with some preference headers:</p>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> msgid <span class="s2">"Hello world!"</span>
 msgstr <span class="s2">""</span>
</code></pre></div>    </div>
    <p>This file shall not be modified by hand. Strictly speaking, we don’t need it for translations, it just a helper. For example, django i18n scripts don’t save it anywhere. But let us keep it, as this file will be useful to update our translations. Also, we can give this file for translator to show him work amount.</p>
  </li>
  <li>
    <p>Create translation file in exact language.</p>

    <p>Command <a href="https://www.gnu.org/software/gettext/manual/html_node/msginit-Invocation.html">msginit</a> can be used for this, it will take template <em>messages.pot</em> as input and produce new file <em>messages.po</em> as output. If fact, we’ll get a copy of our template, but some parts will be set according to chosen language.</p>
  </li>
  <li>
    <p>Translate strings in <em>messages.po</em> manually:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> msgid <span class="s2">"Hello world!"</span>
 msgstr <span class="s2">"Привет, мир!"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Compile translation by command <a href="https://www.gnu.org/software/gettext/manual/html_node/msgfmt-Invocation.html">msgfmt</a>. We’ll get <em>messages.mo</em> as output.</p>
  </li>
  <li>
    <p>If new strings are added somewhere in our application, just update <em>messages.po</em>, don’t create it from scratch.</p>

    <p>Thus previous translations will not be lost. To achieve it:</p>
    <ul>
      <li>again create template <em>.pot</em> (point 3). Yes, it will replace previous <em>messages.pot</em>. But it’s ok as we never modify it manually.</li>
      <li>use command <a href="https://www.gnu.org/software/gettext/manual/html_node/msgmerge-Invocation.html">msgmerge</a>, it will synchronise <em>.po</em> and <em>.pot</em> files.</li>
      <li>repeat points 5 and 6.</li>
    </ul>
  </li>
</ol>

<p>That’s it. If function <code class="language-plaintext highlighter-rouge">_</code> in our project works properly, then englishman will see “Hello world!”, whereas russian - “Привет, мир!”.</p>

<p>It remains unclear, how function <code class="language-plaintext highlighter-rouge">_</code> is implemented and where we can get it. Also, how we discover user preferred language, who is he - englishman or russian? Where we can get those utilities <code class="language-plaintext highlighter-rouge">xgettext</code>, <code class="language-plaintext highlighter-rouge">msginit</code>, <code class="language-plaintext highlighter-rouge">msgmerge</code>, <code class="language-plaintext highlighter-rouge">msgfmt</code>?</p>

<p>Let’s go step by step.</p>

<h4 id="function-_">Function _</h4>

<p>This function can be written manually, as python has builtin support of <a href="https://docs.python.org/2/library/gettext.html">gettext</a>. However, tornado and django already implemented it. We need just to assign name <code class="language-plaintext highlighter-rouge">_</code> to it.  <br />
Django example:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">ugettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="n">_</span><span class="p">(</span><span class="s">"Hello world!"</span><span class="p">)</span>
</code></pre></div></div>

<p>And tornado:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SomeHandler</span><span class="p">(</span><span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">translate</span>
        <span class="n">_</span><span class="p">(</span><span class="s">"Hello world!"</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="how-function-_-discover-user-preferred-language">How function <code class="language-plaintext highlighter-rouge">_</code> discover user preferred language?</h4>

<p>In most simple case web application knows language from HTTP header Accept-Language (preferred language is set in browser settings). Django and tornado have it.  <br />
For more complicated logic, when for example user can specify locale in his profile on web site, both frameworks have corresponding means for it.  <br />
Unlike django, tornado can <strong>not</strong> determine language from url prefix out of the box. I mean that django can show russian content for url <code class="language-plaintext highlighter-rouge">/ru/.../</code> and english content for <code class="language-plaintext highlighter-rouge">/en/.../</code>. But tornado haven’t this functionality, we must implement it manually.</p>

<h4 id="where-to-get-utils-xgettext-msginit-msgmerge-msgfmt">Where to get utils <code class="language-plaintext highlighter-rouge">xgettext</code>, <code class="language-plaintext highlighter-rouge">msginit</code>, <code class="language-plaintext highlighter-rouge">msgmerge</code>, <code class="language-plaintext highlighter-rouge">msgfmt</code></h4>

<p>Install :).</p>

<p>Some Ubuntu versions already have them. If not, run this command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>gettext
</code></pre></div></div>

<p>OSX:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew <span class="nb">install </span>gettext
brew <span class="nb">link </span>gettext <span class="nt">--force</span>
</code></pre></div></div>

<p>Windows binaries can be downloaded from here (haven’t tried): <a href="http://gnuwin32.sourceforge.net/packages/gettext.htm">http://gnuwin32.sourceforge.net/packages/gettext.htm</a></p>

<p>If you are having trouble with install, then you can use builtin python scripts: <a href="https://docs.python.org/2/library/gettext.html#internationalizing-your-programs-and-modules"><code class="language-plaintext highlighter-rouge">pygettext.py</code>, <code class="language-plaintext highlighter-rouge">msgfmt.py</code></a>. But they have much less features, than xgettext. For example, no <em>msgmerge</em> script that is extremely useful.</p>

<p>One solution is also available - <a href="http://babel.pocoo.org/">babel</a> package. It implements many xgettext utils in python, including msgmerge. So we don’t need xgettext to be installed. I’ll describe this approach later in this article.</p>

<h2 id="differences-between-tornado-and-django">Differences between tornado and django</h2>

<p>Before starting the step by step instruction of implementing i18n in tornado, i want to pay attention on one feature.  <br />
It is extremely important for understanding how tornado is working.</p>

<p>The main differences between tornado and django is that tornado runs in single process whereas django - not. How it corresponds to text translation?  <br />
In django we can mark strings as translatable anywhere in code, even in models. For such purpose django has ‘lazy’ function, for example <a href="https://docs.djangoproject.com/en/dev/topics/i18n/translation/#working-with-lazy-translation-objects">ugettext_lazy</a>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">ugettext_lazy</span> <span class="k">as</span> <span class="n">_</span>

<span class="k">class</span> <span class="nc">SomeModel</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"Title"</span><span class="p">),</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</code></pre></div></div>

<p>Function <code class="language-plaintext highlighter-rouge">ugettext_lazy</code> doesn’t return string immediately, only at direct access, when locale will be discovered. But how it knows this locale?  <br />
Obviously, client must make a request, so we can determine some information about visitor from this request and discover his localisation. After that django will store found language in thread global variable (using function <a href="https://docs.djangoproject.com/en/dev/ref/utils/#django.utils.translation.activate">activate()</a>). Remember, that django process every request in separate process.  <br />
That is why function <code class="language-plaintext highlighter-rouge">ugettext_lazy</code> can be used anywhere in code, it will translate text correctly. It doesn’t need the request instance as all needed data will be taken from global variable.</p>

<p>In tornado such approach is not working because it always run in single thread. It is a feature of asynchronous applications.  <br />
But what can happen, if we’ll try to implement this “lazy” pattern?  <br />
Let’s try. Take a look at this simple tornado project. For “lazy” realisation we’ll use <a href="https://pypi.python.org/pypi/speaklater">speaklater</a> package:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">local</span>
<span class="kn">import</span> <span class="nn">tornado.web</span>
<span class="kn">from</span> <span class="nn">speaklater</span> <span class="kn">import</span> <span class="n">make_lazy_gettext</span>

<span class="n">_active</span> <span class="o">=</span> <span class="n">local</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">activate</span><span class="p">(</span><span class="n">current_locale</span><span class="p">):</span>
    <span class="n">_active</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">current_locale</span>

<span class="k">def</span> <span class="nf">gettext</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_active</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">translate</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="n">_</span> <span class="o">=</span> <span class="n">make_lazy_gettext</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">gettext</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">HiModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">hello</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">"Hello, world!"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">DoneModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">done</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">"Fuh, done"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">HomeHandler</span><span class="p">(</span><span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HomeHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">prepare</span><span class="p">()</span>
        <span class="n">activate</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">locale</span><span class="p">)</span>  <span class="c1"># set globally locale from request
</span>
    <span class="o">@</span><span class="n">tornado</span><span class="p">.</span><span class="n">gen</span><span class="p">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">hello_model</span> <span class="o">=</span> <span class="n">HiModel</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">hello_model</span><span class="p">.</span><span class="n">hello</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"&lt;br/&gt;"</span><span class="p">)</span>
        <span class="n">done_model</span> <span class="o">=</span> <span class="n">DoneModel</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">done_model</span><span class="p">.</span><span class="n">done</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"&lt;br/&gt;"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">finish</span><span class="p">()</span>


<span class="n">application</span> <span class="o">=</span> <span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">Application</span><span class="p">([</span>
    <span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s">"/"</span><span class="p">,</span> <span class="n">HomeHandler</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'home'</span><span class="p">),</span>
<span class="p">])</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">application</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">8888</span><span class="p">)</span>
    <span class="n">project_folder</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
    <span class="n">tornado</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">load_gettext_translations</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_folder</span><span class="p">,</span> <span class="s">'locale'</span><span class="p">),</span> <span class="s">'messages'</span><span class="p">)</span>
    <span class="n">tornado</span><span class="p">.</span><span class="n">ioloop</span><span class="p">.</span><span class="n">IOLoop</span><span class="p">.</span><span class="n">instance</span><span class="p">().</span><span class="n">start</span><span class="p">()</span>
</code></pre></div></div>

<p>Here <code class="language-plaintext highlighter-rouge">HiModel</code> and <code class="language-plaintext highlighter-rouge">DoneModel</code> represent some models. The most important part - they have translatable strings.  <br />
Translation in <em>messages.po</em> look like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msgid <span class="s2">"Hello, world!"</span>
msgstr <span class="s2">"Привет, мир!"</span>

msgid <span class="s2">"Fuh, done"</span>
msgstr <span class="s2">"Фух, вроде готово"</span>
</code></pre></div></div>

<p>Run this small server.  <br />
Assume, that “browser_en” have english preferred language and “browser_ru” - russian.</p>

<p>Open url <a href="http://127.0.0.1:8888/">http://127.0.0.1:8888/</a> in browser_ru and see:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Привет, мир!
Фух, вроде готово
</code></pre></div></div>

<p>Same action in browser_en:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hello, world!
Fuh, done
</code></pre></div></div>

<p>All is working fine. But let’s try to add async task. For simplicity we’ll use <a href="http://tornado.readthedocs.org/en/latest/ioloop.html#tornado.ioloop.IOLoop.add_timeout">async timer</a>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">tornado</span><span class="p">.</span><span class="n">gen</span><span class="p">.</span><span class="n">coroutine</span>
<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">hello_model</span> <span class="o">=</span> <span class="n">HiModel</span><span class="p">()</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">hello_model</span><span class="p">.</span><span class="n">hello</span><span class="p">))</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"&lt;br/&gt;"</span><span class="p">)</span>
    <span class="n">io_loop</span> <span class="o">=</span> <span class="n">tornado</span><span class="p">.</span><span class="n">ioloop</span><span class="p">.</span><span class="n">IOLoop</span><span class="p">.</span><span class="n">instance</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">tornado</span><span class="p">.</span><span class="n">gen</span><span class="p">.</span><span class="n">Task</span><span class="p">(</span><span class="n">io_loop</span><span class="p">.</span><span class="n">add_timeout</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">done_model</span> <span class="o">=</span> <span class="n">DoneModel</span><span class="p">()</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">done_model</span><span class="p">.</span><span class="n">done</span><span class="p">))</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"&lt;br/&gt;"</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">finish</span><span class="p">()</span>
</code></pre></div></div>

<p>So we just added these lines:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">io_loop</span> <span class="o">=</span> <span class="n">tornado</span><span class="p">.</span><span class="n">ioloop</span><span class="p">.</span><span class="n">IOLoop</span><span class="p">.</span><span class="n">instance</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">tornado</span><span class="p">.</span><span class="n">gen</span><span class="p">.</span><span class="n">Task</span><span class="p">(</span><span class="n">io_loop</span><span class="p">.</span><span class="n">add_timeout</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
</code></pre></div></div>

<p>between models <code class="language-plaintext highlighter-rouge">HiModel</code> and <code class="language-plaintext highlighter-rouge">DoneModel</code>.  <br />
Now open url first from browser_ru, then from browser_en, but before timer in browser_ru will be done.</p>

<p>In browser_ru we’ll see:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Привет, мир!
Fuh, done
</code></pre></div></div>

<p>and in browser_en:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hello, world!
Fuh, done
</code></pre></div></div>

<p>I hope you already understand, why browser_ru show one string in russian and one in english. Just in case let’s describe this situation in details.</p>

<p>When browser_ru made a request, we have set russian locale globally.  <br />
Then async task was fired.  <br />
While async task was working, browser_en made a request. Now we have set english locale globally.  <br />
Async task, that was fired by browser_ru, was finished and handler continued to work. But language was modified from another request, so from this moment strings 
will be translated to english, not to russian.</p>

<p>Therefore we can make a decision, that in tornado we can correctly discover language <strong>only</strong> from request handler instance.</p>

<h2 id="i18n-in-tornado-using-xgettext-">i18n in tornado using xgettext <a name="tornado-i18n-xgettext"></a></h2>

<p>In <a href="http://www.tornadoweb.org/en/stable/locale.html#module-tornado.locale">tornado docs</a> realisation of i18n is described quite poorly, so i’ll try to make a step by step instruction here.</p>

<p>To my mind, the best way to describe is to show on example. Therefore let’s create simple tornado project.</p>

<p>Project structure:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>└── project
    ├── app.py
    ├── home.html
    └── requirements.txt
</code></pre></div></div>

<p>app.py:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">tornado.ioloop</span>
<span class="kn">import</span> <span class="nn">tornado.web</span>

<span class="k">class</span> <span class="nc">HomeHandler</span><span class="p">(</span><span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="s">"home.html"</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">"Hello, world!"</span><span class="p">)</span>

<span class="n">application</span> <span class="o">=</span> <span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">Application</span><span class="p">([</span>
    <span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s">"/"</span><span class="p">,</span> <span class="n">HomeHandler</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'home'</span><span class="p">),</span>
<span class="p">])</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">application</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">8888</span><span class="p">)</span>
    <span class="n">tornado</span><span class="p">.</span><span class="n">ioloop</span><span class="p">.</span><span class="n">IOLoop</span><span class="p">.</span><span class="n">instance</span><span class="p">().</span><span class="n">start</span><span class="p">()</span>
</code></pre></div></div>

<p>home.html:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
   <span class="nt">&lt;head&gt;&lt;title&gt;</span>Home page<span class="nt">&lt;/title&gt;&lt;/head&gt;</span>
   <span class="nt">&lt;body&gt;</span>
     <span class="nt">&lt;div&gt;</span>Home page<span class="nt">&lt;/div&gt;</span>
     <span class="nt">&lt;div&gt;</span>{{text}}<span class="nt">&lt;/div&gt;</span>
   <span class="nt">&lt;/body&gt;</span>
 <span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>requirements.txt:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tornado</span><span class="o">==</span><span class="mf">4.0</span><span class="p">.</span><span class="mi">2</span>
</code></pre></div></div>

<h4 id="goal">Goal</h4>

<p>Add support of two languages, english and russian, in tornado project. If browser have english as preferred language - show english content and if russian - show russian content correspondingly.</p>

<h4 id="1-all-text-in-code-must-be-in-english">1. All text in code must be in english</h4>

<p>We already have it, currently there are such strings:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"Hello, world!"</span>  <span class="c"># app.py</span>
<span class="s2">"Home page"</span>    <span class="c"># home.html</span>
</code></pre></div></div>

<h4 id="2-mark-text">2. Mark text</h4>

<p>First of all we need to mark translatable strings (point 2 from <a href="#gettext">gettext</a> section).  <br />
As we remember, it is done by function <code class="language-plaintext highlighter-rouge">_</code>.
In request handler code we can get it like this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">translate</span>
</code></pre></div></div>

<p>Handler code (file app.py):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">HomeHandler</span><span class="p">(</span><span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">translate</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="s">"home.html"</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">"Hello, world!"</span><span class="p">))</span>
</code></pre></div></div>

<p>In templates this function is available by default, it is defined in method <a href="https://github.com/tornadoweb/tornado/blob/branch4.0/tornado/web.py#L788">get_template_namespace()</a>.  <br />
Template code (file home.html):</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
   <span class="nt">&lt;head&gt;&lt;title&gt;</span>{{_("Home page")}}<span class="nt">&lt;/title&gt;&lt;/head&gt;</span>
   <span class="nt">&lt;body&gt;</span>
     <span class="nt">&lt;div&gt;</span>{{_("Home page")}}<span class="nt">&lt;/div&gt;</span>
     <span class="nt">&lt;div&gt;</span>{{text}}<span class="nt">&lt;/div&gt;</span>
   <span class="nt">&lt;/body&gt;</span>
 <span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>Tornado template system execute python code, that is placed inside double braces <code class="language-plaintext highlighter-rouge">{{ ... }}</code>.</p>

<h4 id="3-create-file-with-translations">3. Create file with translations</h4>

<p>Create locale folder in the root of our project:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>locale
</code></pre></div></div>

<p>Next create file <code class="language-plaintext highlighter-rouge">makemessages.sh</code> in root and put such bash code there:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash </span>
<span class="c"># get arguments and init variables</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"$#"</span> <span class="nt">-lt</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"Usage: </span><span class="nv">$0</span><span class="s2"> &lt;locale&gt; [optional: &lt;domain_name&gt;]"</span>
    <span class="nb">exit </span>1
<span class="k">fi
</span><span class="nv">locale</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">domain</span><span class="o">=</span><span class="s2">"messages"</span>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nv">domain</span><span class="o">=</span><span class="nv">$2</span>
<span class="k">fi
</span><span class="nv">locale_dir</span><span class="o">=</span><span class="s2">"locale/</span><span class="k">${</span><span class="nv">locale</span><span class="k">}</span><span class="s2">/LC_MESSAGES"</span>
<span class="nv">pot_file</span><span class="o">=</span><span class="s2">"locale/</span><span class="k">${</span><span class="nv">domain</span><span class="k">}</span><span class="s2">.pot"</span>
<span class="nv">po_file</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">locale_dir</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">domain</span><span class="k">}</span><span class="s2">.po"</span>
<span class="c"># create folders if not exists</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$locale_dir</span>
<span class="c"># create .pot file</span>
find <span class="nb">.</span> <span class="nt">-iname</span> <span class="s2">"*.html"</span> <span class="nt">-o</span> <span class="nt">-iname</span> <span class="s2">"*.py"</span> | xargs <span class="se">\</span>
    xgettext <span class="nt">--output</span><span class="o">=</span><span class="k">${</span><span class="nv">pot_file</span><span class="k">}</span> <span class="nt">--language</span><span class="o">=</span>Python <span class="nt">--from-code</span><span class="o">=</span>UTF-8 <span class="se">\</span>
    <span class="nt">--sort-by-file</span> <span class="nt">--keyword</span><span class="o">=</span>_ <span class="nt">--keyword</span><span class="o">=</span>_:1,2 <span class="nt">--no-wrap</span>
<span class="c"># init .po file, if it doesn't exist yet</span>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="nv">$po_file</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span>msginit <span class="nt">--input</span><span class="o">=</span><span class="k">${</span><span class="nv">pot_file</span><span class="k">}</span> <span class="nt">--output-file</span><span class="o">=</span><span class="k">${</span><span class="nv">po_file</span><span class="k">}</span> <span class="nt">--no-wrap</span> <span class="nt">--locale</span><span class="o">=</span><span class="k">${</span><span class="nv">locale</span><span class="k">}</span>
<span class="k">else</span>
    <span class="c"># update .po file</span>
    msgmerge <span class="nt">--no-wrap</span> <span class="nt">--sort-by-file</span> <span class="nt">--output-file</span><span class="o">=</span><span class="k">${</span><span class="nv">po_file</span><span class="k">}</span> <span class="k">${</span><span class="nv">po_file</span><span class="k">}</span> <span class="k">${</span><span class="nv">pot_file</span><span class="k">}</span>
<span class="k">fi</span>
</code></pre></div></div>

<p>Add execution rights:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chmod </span>a+x makemessages.sh
</code></pre></div></div>

<p>To launch it is needed to specify language tag. This is the language that we want to implement (in this example - russian):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./makemessages.sh ru
</code></pre></div></div>

<p>During first launch it can ask you email.  <br />
After execution files <em>messages.pot</em> and <em>messages.po</em> will be created:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>project
├── locale
│   ├── ru
│   │   └── LC_MESSAGES
│   │       └── messages.po
│   └── messages.pot
├── app.py
├── home.html
├── requirements.txt
└── makemessages.sh
</code></pre></div></div>

<p>Contents of messages.po:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Russian translations for tornado_i18n package.</span>
<span class="c"># Copyright (C) 2015 THE tornado_i18n'S COPYRIGHT HOLDER</span>
<span class="c"># This file is distributed under the same license as the tornado_i18n package.</span>
<span class="c"># stalk &lt;alexevseev@gmail.com&gt;, 2015.</span>
<span class="c">#</span>
msgid <span class="s2">""</span>
msgstr <span class="s2">""</span>
<span class="s2">"Project-Id-Version: tornado_i18n</span><span class="se">\n</span><span class="s2">"</span>
<span class="s2">"Report-Msgid-Bugs-To: </span><span class="se">\n</span><span class="s2">"</span>
<span class="s2">"POT-Creation-Date: 2015-01-30 12:27+0300</span><span class="se">\n</span><span class="s2">"</span>
<span class="s2">"PO-Revision-Date: 2015-01-30 12:27+0300</span><span class="se">\n</span><span class="s2">"</span>
<span class="s2">"Last-Translator: stalk &lt;alexevseev@gmail.com&gt;</span><span class="se">\n</span><span class="s2">"</span>
<span class="s2">"Language-Team: Russian</span><span class="se">\n</span><span class="s2">"</span>
<span class="s2">"Language: ru</span><span class="se">\n</span><span class="s2">"</span>
<span class="s2">"MIME-Version: 1.0</span><span class="se">\n</span><span class="s2">"</span>
<span class="s2">"Content-Type: text/plain; charset=ASCII</span><span class="se">\n</span><span class="s2">"</span>
<span class="s2">"Content-Transfer-Encoding: 8bit</span><span class="se">\n</span><span class="s2">"</span>
<span class="s2">"Plural-Forms: nplurals=3; plural=(n%10==1 &amp;&amp; n%100!=11 ? 0 : n%10&gt;=2 &amp;&amp; n%10&lt;=4 &amp;&amp; (n%100&lt;10 || n%100&gt;=20) ? 1 : 2);</span><span class="se">\n</span><span class="s2">"</span>

<span class="c">#: app.py:8</span>
msgid <span class="s2">"Hello, world!"</span>
msgstr <span class="s2">""</span>

<span class="c">#: home.html:2 home.html:4</span>
msgid <span class="s2">"Home page"</span>
msgstr <span class="s2">""</span>
</code></pre></div></div>

<p>We <strong>must</strong> change charset=ASCII to charset=UTF-8 here, other headers are optional:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"Content-Type: text/plain; charset=UTF-8\n"
</code></pre></div></div>

<h4 id="4-do-translation">4. Do translation</h4>

<p>Fill empty strings like msgstr “” in <em>messages.po</em> (not <em>.pot</em>!):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#: app.py:8</span>
msgid <span class="s2">"Hello, world!"</span>
msgstr <span class="s2">"Привет, мир!"</span>

<span class="c">#: home.html:2 home.html:4</span>
msgid <span class="s2">"Home page"</span>
msgstr <span class="s2">"Домашняя страница"</span>
</code></pre></div></div>

<h4 id="5-compile-translation">5. Compile translation</h4>

<p>Create file <code class="language-plaintext highlighter-rouge">compilemessages.sh</code> with bash code:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash </span>
<span class="c"># get arguments and init variables</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"$#"</span> <span class="nt">-lt</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"Usage: </span><span class="nv">$0</span><span class="s2"> &lt;locale&gt; [optional: &lt;domain_name&gt;]"</span>
    <span class="nb">exit </span>1
<span class="k">fi
</span><span class="nv">locale</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">domain</span><span class="o">=</span><span class="s2">"messages"</span>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nv">domain</span><span class="o">=</span><span class="nv">$2</span>
<span class="k">fi
</span><span class="nv">locale_dir</span><span class="o">=</span><span class="s2">"locale/</span><span class="k">${</span><span class="nv">locale</span><span class="k">}</span><span class="s2">/LC_MESSAGES"</span>
<span class="nv">po_file</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">locale_dir</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">domain</span><span class="k">}</span><span class="s2">.po"</span>
<span class="nv">mo_file</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">locale_dir</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">domain</span><span class="k">}</span><span class="s2">.mo"</span>
<span class="c"># create .mo file from .po</span>
msgfmt <span class="k">${</span><span class="nv">po_file</span><span class="k">}</span> <span class="nt">--output-file</span><span class="o">=</span><span class="k">${</span><span class="nv">mo_file</span><span class="k">}</span>
</code></pre></div></div>

<p>Add execution rights:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chmod </span>a+x compilemessages.sh
</code></pre></div></div>

<p>To launch specify same language tag, as in <em>makemessages.sh</em>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./compilemessages.sh ru
</code></pre></div></div>

<p>We’ve got file <em>locale/ru/LC_MESSAGES/messages.mo</em>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>project
├── locale
│   ├── ru
│   │   └── LC_MESSAGES
│   │       ├── messages.po
│   │       └── messages.mo
│   └── messages.pot
├── app.py
├── home.html
├── requirements.txt
├── compilemessages.sh
└── makemessages.sh
</code></pre></div></div>

<h4 id="6-link-translations-with-our-project">6. Link translations with our project</h4>

<p>To achieve it call function <a href="http://www.tornadoweb.org/en/stable/locale.html#tornado.locale.load_gettext_translations">load_gettext_translations()</a>.</p>

<p>app.py:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">tornado</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">load_gettext_translations</span><span class="p">(</span><span class="s">'locale'</span><span class="p">,</span> <span class="s">'messages'</span><span class="p">)</span>
    <span class="n">application</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">8888</span><span class="p">)</span>
    <span class="n">tornado</span><span class="p">.</span><span class="n">ioloop</span><span class="p">.</span><span class="n">IOLoop</span><span class="p">.</span><span class="n">instance</span><span class="p">().</span><span class="n">start</span><span class="p">()</span>
</code></pre></div></div>

<p>Let’s try to start the project.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python app.py
</code></pre></div></div>

<p>Open address <a href="http://127.0.0.1:8888/">http://127.0.0.1:8888/</a> in browser_en:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Home page
Hello, world!
</code></pre></div></div>

<p>and brower_ru:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Домашняя страница
Привет, мир!
</code></pre></div></div>

<p>That’s it, translation is done!</p>

<h4 id="7-update-translation">7. Update translation</h4>

<p>Imagine, that in home.html we have new text, that must be translated:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div&gt;</span>{{_("Good buy!")}}<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>We just execute our script:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./makemessages.sh ru
</code></pre></div></div>

<p>fill translations in updated <em>messages.po</em>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#: home.html:6</span>
msgid <span class="s2">"Good buy!"</span>
msgstr <span class="s2">"До свидания!"</span>
</code></pre></div></div>

<p>compile:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./compilemessages.sh ru
</code></pre></div></div>
<p>and restart server</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python app.py
</code></pre></div></div>

<p>That’s all!</p>

<h4 id="8-plural-forms">8. Plural forms</h4>

<p>gettext can handle plural forms, here is how it works:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ngettext<span class="o">(</span><span class="s2">"{count} event is gonna happen"</span>, <span class="s2">"{count} events are gonna happen"</span>, count<span class="o">)</span>.format<span class="o">(</span><span class="nv">count</span><span class="o">=</span>count<span class="o">)</span>
</code></pre></div></div>

<p>ngettext - standard function name for plural forms that is used in gettext.  <br />
But tornado function <code class="language-plaintext highlighter-rouge">self.locale.translate</code> also accept plural forms arguments. So we can use our usual name <code class="language-plaintext highlighter-rouge">_</code> instead of ngettext:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_</span><span class="p">(</span><span class="s">"{count} event is gonna happen"</span><span class="p">,</span> <span class="s">"{count} events are gonna happen"</span><span class="p">,</span> <span class="n">count</span><span class="p">).</span><span class="nb">format</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>
</code></pre></div></div>

<p>Pay attention on xgettext options in your script above:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">--keyword</span><span class="o">=</span>_ <span class="nt">--keyword</span><span class="o">=</span>_:1,2
</code></pre></div></div>

<p>With this options we tell the parser, that function <code class="language-plaintext highlighter-rouge">_</code> can accept both single string and plural form strings as arguments.</p>

<p>Plural forms function will return either single form, either plural form, depending on provided count.  <br />
Example in english:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_</span><span class="p">(</span><span class="s">"{count} event is gonna happen"</span><span class="p">,</span> <span class="s">"{count} events are gonna happen"</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nb">format</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># output
</span><span class="s">"1 event is gonna happen"</span>

<span class="n">_</span><span class="p">(</span><span class="s">"{count} event is gonna happen"</span><span class="p">,</span> <span class="s">"{count} events are gonna happen"</span><span class="p">,</span> <span class="mi">2</span><span class="p">).</span><span class="nb">format</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># output
</span><span class="s">"2 events are gonna happen"</span>
</code></pre></div></div>

<p>As we can see, english language have only 1 plural form. I.e. when <code class="language-plaintext highlighter-rouge">count &gt; 1</code> the output will be the same.</p>

<p>However russian language have 3 plural forms (and some other languages even more). Here is an example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1,21,31 событие должно случиться
2,3,4,22 события должно случиться
5,6,7,8,9,20,25 событий должно случиться
</code></pre></div></div>

<p>If we’ll do everything correctly, gettext will produce the right form.</p>

<p>Let’s implement it in our example.  <br />
Add following line in home.html:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div&gt;</span>{{_("{count} event is gonna happen", "{count} events are gonna happen", count).format(count=count)}}<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>in handler from app.py:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">HomeHandler</span><span class="p">(</span><span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">translate</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">'count'</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="s">"home.html"</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">"Hello, world!"</span><span class="p">),</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>
</code></pre></div></div>

<p>Update translations:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./makemessages.sh ru
</code></pre></div></div>

<p>Now we can find such strings in <em>locale/ru/LC_MESSAGES/messages.po</em>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#: home.html:6</span>
<span class="c">#, python-brace-format</span>
msgid <span class="s2">"{count} event is gonna happen"</span>
msgid_plural <span class="s2">"{count} events are gonna happen"</span>
msgstr[0] <span class="s2">""</span>
msgstr[1] <span class="s2">""</span>
msgstr[2] <span class="s2">""</span>
</code></pre></div></div>

<p>gettext knows, that russian langauge has 3 plural forms.  <br />
Look at header, that was created by msginit:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"Plural-Forms: nplurals=3; plural=(n%10==1 &amp;&amp; n%100!=11 ? 0 : n%10&gt;=2 &amp;&amp; n%10&lt;=4 &amp;&amp; (n%100&lt;10 || n%100&gt;=20) ? 1 : 2);</span><span class="se">\n</span><span class="s2">"</span>
</code></pre></div></div>

<p>Conditions from this header define correct plural form depending on provided count.  <br />
Do the translation:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#: home.html:6</span>
<span class="c">#, python-brace-format</span>
msgid <span class="s2">"{count} event is gonna happen"</span>
msgid_plural <span class="s2">"{count} events are gonna happen"</span>
msgstr[0] <span class="s2">"{count} событие должно случиться"</span>
msgstr[1] <span class="s2">"{count} события должно случиться"</span>
msgstr[2] <span class="s2">"{count} событий должно случиться"</span>
</code></pre></div></div>

<p>Compile:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./compilemessages.sh ru
</code></pre></div></div>

<p>Start the server and open in browser_ru</p>

<p><a href="http://127.0.0.1:8888/">http://127.0.0.1:8888/</a>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 событие должно случиться
</code></pre></div></div>

<p><a href="http://127.0.0.1:8888/?count=2">http://127.0.0.1:8888/?count=2</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2 события должно случиться
</code></pre></div></div>

<p><a href="http://127.0.0.1:8888/?count=5">http://127.0.0.1:8888/?count=5</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>5 событий должно случиться
</code></pre></div></div>

<p>Great!</p>

<h4 id="9-custom-logic-for-discovering-language">9. Custom logic for discovering language</h4>

<p>Language was determined from browser settings so far. But what if we want to let the user to choose his preferred locale in our web project, for example in his profile.  <br />
This logic can be easily customised and browser settings will not be the mandatory setting.  <br />
Just override handler’s method <code class="language-plaintext highlighter-rouge">get_user_locale()</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">HomeHandler</span><span class="p">(</span><span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">):</span>

<span class="k">def</span> <span class="nf">get_user_locale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tornado</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"ru"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">translate</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="s">"home.html"</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">"Hello, world!"</span><span class="p">))</span>
</code></pre></div></div>

<p>Now regardless of browser settings the russian content will always be shown.</p>

<h2 id="babel-package">babel package</h2>

<p>Go further. <a href="http://babel.pocoo.org/">babel</a> provides access to CLDR data from python. Also it implement xgettext commands in pure python, thus we don’t need xgettext installed. But now let’s look at CLDR more carefully.</p>

<p>Suppose we want to show some product price is US dollars. But in different countries different currency format is used.  <br />
For example in Russia price is often written as: 99,00 $  <br />
whereas in USA: $99.00</p>

<p>All this information is available in CLDR! We can easily use it thanks to babel.  <br />
Install babel:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>babel
</code></pre></div></div>

<p>Modify app.py:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">tornado.ioloop</span>
<span class="kn">import</span> <span class="nn">tornado.web</span>
<span class="kn">from</span> <span class="nn">babel.numbers</span> <span class="kn">import</span> <span class="n">format_currency</span>


<span class="k">class</span> <span class="nc">HomeHandler</span><span class="p">(</span><span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">translate</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">'count'</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">format_usd</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">format_currency</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s">"USD"</span><span class="p">,</span>
            <span class="n">locale</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">code</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="s">"home.html"</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">"Hello, world!"</span><span class="p">),</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span>
            <span class="n">format_usd</span><span class="o">=</span><span class="n">format_usd</span><span class="p">)</span>
</code></pre></div></div>

<p>add price in home.html:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div&gt;</span>{{format_usd(99)}}<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>That’s all we need to do.  <br />
browser_ru will show:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>99,00 $
</code></pre></div></div>

<p>browser_en:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$99.00
</code></pre></div></div>

<p>This is only one of many features available in babel. It have translations of week days, months, date formats and many other. And we shall use it, no need to translate everything by hand.</p>

<h2 id="i18n-in-tornado-using-babel-">i18n in tornado using babel <a name="tornado-i18n-babel"></a></h2>

<p>As I said before, babel implement main xgettext commands in python. So we don’t need xgettext installed. Also, babel allows to declare custom syntax for parsing. It is useful when we have templates with some specific syntax in it.</p>

<p>Take again our simple example. In theory we just need to change our scripts <em>makemessages.sh</em> and <em>compilemessages.sh</em>.</p>

<p>For the purity of the experiment delete all files inside locale folder. Project structure now looks like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>project
├── locale
├── app.py
├── home.html
├── requirements.txt
├── makemessages.sh
└── compilemessages.sh
</code></pre></div></div>

<p>Install babel, if not already:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>babel
</code></pre></div></div>

<p>For tornado templates parsing we’ll need package <a href="https://pypi.python.org/pypi/Tornado-Babel/">tornado-babel</a>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>tornado-babel
</code></pre></div></div>

<p>First of all create file <em>locale/babel.cfg</em> with following code:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>python: <span class="k">**</span>.py]
<span class="o">[</span>tornado: <span class="k">**</span>.html]
</code></pre></div></div>

<p>By this code we tell babel, what files must be used for parsing (as you remember, for xgettext we used <code class="language-plaintext highlighter-rouge">find . -iname "*.html" -o -iname "*.py"</code>).</p>

<p>Modify our <em>makemessages.sh</em>, so babel will be used instead of xgettext:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash </span>
<span class="c"># get arguments and init variables</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"$#"</span> <span class="nt">-lt</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"Usage: </span><span class="nv">$0</span><span class="s2"> &lt;locale&gt; [optional: &lt;domain_name&gt;]"</span>
    <span class="nb">exit </span>1
<span class="k">fi
</span><span class="nv">locale</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">domain</span><span class="o">=</span><span class="s2">"messages"</span>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nv">domain</span><span class="o">=</span><span class="nv">$2</span>
<span class="k">fi
</span><span class="nv">base_dir</span><span class="o">=</span><span class="s2">"locale"</span>
<span class="nv">locale_dir</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">base_dir</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">locale</span><span class="k">}</span><span class="s2">/LC_MESSAGES"</span>
<span class="nv">pot_file</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">base_dir</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">domain</span><span class="k">}</span><span class="s2">.pot"</span>
<span class="nv">po_file</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">locale_dir</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">domain</span><span class="k">}</span><span class="s2">.po"</span>
<span class="nv">babel_config</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">base_dir</span><span class="k">}</span><span class="s2">/babel.cfg"</span>
<span class="c"># create pot template</span>
pybabel extract ./ <span class="nt">--output</span><span class="o">=</span><span class="k">${</span><span class="nv">pot_file</span><span class="k">}</span> <span class="se">\</span>
    <span class="nt">--charset</span><span class="o">=</span>UTF-8 <span class="nt">--no-wrap</span> <span class="nt">--sort-by-file</span> <span class="se">\</span>
    <span class="nt">--keyword</span><span class="o">=</span>_ <span class="nt">--mapping</span><span class="o">=</span><span class="k">${</span><span class="nv">babel_config</span><span class="k">}</span>
<span class="c"># init .po file, if it doesn't exist yet</span>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="nv">$po_file</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span>pybabel init <span class="nt">--input-file</span><span class="o">=</span><span class="k">${</span><span class="nv">pot_file</span><span class="k">}</span> <span class="nt">--output-dir</span><span class="o">=</span><span class="k">${</span><span class="nv">base_dir</span><span class="k">}</span> <span class="se">\</span>
        <span class="nt">--domain</span><span class="o">=</span><span class="k">${</span><span class="nv">domain</span><span class="k">}</span> <span class="nt">--locale</span><span class="o">=</span><span class="k">${</span><span class="nv">locale</span><span class="k">}</span> <span class="nt">--no-wrap</span>
<span class="k">else</span>
    <span class="c"># update .po file</span>
    pybabel update <span class="nt">--domain</span><span class="o">=</span><span class="k">${</span><span class="nv">domain</span><span class="k">}</span> <span class="nt">--input-file</span><span class="o">=</span><span class="k">${</span><span class="nv">pot_file</span><span class="k">}</span> <span class="se">\</span>
    <span class="nt">--output-dir</span><span class="o">=</span><span class="k">${</span><span class="nv">base_dir</span><span class="k">}</span> <span class="nt">--locale</span><span class="o">=</span><span class="k">${</span><span class="nv">locale</span><span class="k">}</span> <span class="nt">--no-wrap</span>
<span class="k">fi</span>
</code></pre></div></div>

<p>And compilemessages.sh:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash </span>
<span class="c"># get arguments and init variables</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"$#"</span> <span class="nt">-lt</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"Usage: </span><span class="nv">$0</span><span class="s2"> &lt;locale&gt; [optional: &lt;domain_name&gt;]"</span>
    <span class="nb">exit </span>1
<span class="k">fi
</span><span class="nv">locale</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">domain</span><span class="o">=</span><span class="s2">"messages"</span>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nv">domain</span><span class="o">=</span><span class="nv">$2</span>
<span class="k">fi
</span><span class="nv">locale_dir</span><span class="o">=</span><span class="s2">"locale/</span><span class="k">${</span><span class="nv">locale</span><span class="k">}</span><span class="s2">/LC_MESSAGES"</span>
<span class="nv">po_file</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">locale_dir</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">domain</span><span class="k">}</span><span class="s2">.po"</span>
<span class="nv">mo_file</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">locale_dir</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">domain</span><span class="k">}</span><span class="s2">.mo"</span>
<span class="c"># create .mo file from .po</span>
pybabel compile <span class="nt">--locale</span><span class="o">=</span><span class="k">${</span><span class="nv">locale</span><span class="k">}</span> <span class="nt">--domain</span><span class="o">=</span><span class="k">${</span><span class="nv">domain</span><span class="k">}</span> <span class="nt">--directory</span><span class="o">=</span>locale/
</code></pre></div></div>

<p>Maybe you have noticed, that we use only <code class="language-plaintext highlighter-rouge">--keyword=_</code> option, without <code class="language-plaintext highlighter-rouge">--keyword=_:1,2</code>. Why?  <br />
The thing is that in babel==1.3, that is currently avaliable from pypi, multiple arguments for same function are not supported.  <br />
What impact it have in our case?  <br />
We have to use <code class="language-plaintext highlighter-rouge">ngettext</code> function name for plural forms instead of <code class="language-plaintext highlighter-rouge">_</code>.  <br />
Modify code in app.py a little:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">HomeHandler</span><span class="p">(</span><span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ngettext</span> <span class="o">=</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">translate</span>
        <span class="c1"># ...
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="s">"home.html"</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">"Hello, world!"</span><span class="p">),</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span>
            <span class="n">ngettext</span><span class="o">=</span><span class="n">ngettext</span><span class="p">)</span>
</code></pre></div></div>

<p>and template:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;div&gt;</span>{{ngettext("{count} event is gonna happen", "{count} events are gonna happen", count).format(count=count)}}<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>Other code remains the same.</p>

<p>Create translation files:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./makemessages.sh ru
</code></pre></div></div>

<p>Again do translation in <em>locale/ru/LC_MESSAGES/messages.po</em>.</p>

<p>Compile:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./compilemessages.sh ru
</code></pre></div></div>

<p>During execution of this script we can see something like</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>catalog <span class="s1">'locale/ru/LC_MESSAGES/messages.po'</span> is marked as fuzzy, skipping
</code></pre></div></div>

<p>In that case delete special untrusted translation marks in <em>messages.po</em>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#, fuzzy</span>
</code></pre></div></div>
<p>and compile again.</p>

<p>Now all works similarly. But without xgettext!</p>

<h4 id="fix-babel">Fix babel</h4>

<p>Agree, that uncomfortable to have two functions <code class="language-plaintext highlighter-rouge">_</code> and <code class="language-plaintext highlighter-rouge">ngettext</code>. Let’s fix it! :)  <br />
I’ve send pull-requests into <a href="https://github.com/mitsuhiko/babel/pull/140">babel repo</a> and in <a href="https://github.com/openlabs/tornado-babel/pull/6">tornado-babel repo</a>. Maybe they are already accepted.  <br />
However i’ve created fixed versions to not wait for acceptance. Uninstall current babel and tornado-babel packages:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip uninstall babel
pip uninstall tornado-babel
</code></pre></div></div>

<p>Install fixed versions:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>https://github.com/st4lk/babel/archive/2.1.2-draft.tar.gz
pip <span class="nb">install </span>https://github.com/st4lk/tornado-babel/archive/0.3b.tar.gz
</code></pre></div></div>

<p>Add <code class="language-plaintext highlighter-rouge">--keyword=_1,2</code> option in <em>makemessages.sh</em>.</p>

<p>Was:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">--keyword</span><span class="o">=</span>_ <span class="nt">--mapping</span><span class="o">=</span><span class="k">${</span><span class="nv">babel_config</span><span class="k">}</span>
</code></pre></div></div>
<p>Now:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">--keyword</span><span class="o">=</span>_ <span class="nt">--keyword</span><span class="o">=</span>_:1,2 <span class="nt">--mapping</span><span class="o">=</span><span class="k">${</span><span class="nv">babel_config</span><span class="k">}</span>
</code></pre></div></div>

<p>Remove unnecessary ngettext function.</p>

<p>app.py:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">HomeHandler</span><span class="p">(</span><span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">translate</span>
        <span class="c1"># ...
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="s">"home.html"</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">"Hello, world!"</span><span class="p">),</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>
</code></pre></div></div>

<p>home.html:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div&gt;</span>{{_("{count} event is gonna happen", "{count} events are gonna happen", count).format(count=count)}}<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>Great, now we use babel and code is the same, as with xgettext!</p>

<p>The code of example is available on github: <a href="https://github.com/st4lk/tornado_i18n_example">https://github.com/st4lk/tornado_i18n_example</a></p>

  </div>

  <div class="post-categories">

  <span><a href="/en/category/i18n/">i18n</a></span>
&nbsp;

  <span><a href="/en/category/async/">async</a></span>
&nbsp;

  <span><a href="/en/category/tornado/">tornado</a></span>


</div><div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      
      
      this.page.url = 'https://st4lk.github.io/en/blog/2015/01/31/tornado-internationalization-and-localization/';
      this.page.identifier = 'https://st4lk.github.io/blog/2015/01/31/tornado-internationalization-and-localization.html';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://lexev-dev.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript><a class="u-url" href="/en/blog/2015/01/31/tornado-internationalization-and-localization/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/en/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name"></li><li><a class="u-email" href="mailto:alexevseev@gmail.com">alexevseev@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"></div>

    </div>

  </div>

</footer>
<script id="dsq-count-scr" src="//lexev-dev.disqus.com/count.js" async></script></body>

</html>
