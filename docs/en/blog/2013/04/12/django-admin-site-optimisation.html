<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Django admin site optimisation | Developer articles</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Django admin site optimisation" />
<meta property="og:locale" content="en" />
<meta name="description" content="It is known, that less amount of database attempts leads to better performance. Usually admin page - part of site with low traffic, but anyway it is good, if no additional database calls happen there. It is more pleasant to use it, because page renders faster and also frees server resources. In this post i’ll try to reduce some database attempts in admin page, when model method __unicode__ contains related object field. I suppose, that examples describe the situation more clear." />
<meta property="og:description" content="It is known, that less amount of database attempts leads to better performance. Usually admin page - part of site with low traffic, but anyway it is good, if no additional database calls happen there. It is more pleasant to use it, because page renders faster and also frees server resources. In this post i’ll try to reduce some database attempts in admin page, when model method __unicode__ contains related object field. I suppose, that examples describe the situation more clear." />
<link rel="canonical" href="https://st4lk.github.io/en/blog/2013/04/12/django-admin-site-optimisation.html" />
<meta property="og:url" content="https://st4lk.github.io/en/blog/2013/04/12/django-admin-site-optimisation.html" />
<meta property="og:site_name" content="Developer articles" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2013-04-12T18:19:43+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Django admin site optimisation" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2013-04-12T18:19:43+00:00","datePublished":"2013-04-12T18:19:43+00:00","description":"It is known, that less amount of database attempts leads to better performance. Usually admin page - part of site with low traffic, but anyway it is good, if no additional database calls happen there. It is more pleasant to use it, because page renders faster and also frees server resources. In this post i’ll try to reduce some database attempts in admin page, when model method __unicode__ contains related object field. I suppose, that examples describe the situation more clear.","headline":"Django admin site optimisation","mainEntityOfPage":{"@type":"WebPage","@id":"https://st4lk.github.io/en/blog/2013/04/12/django-admin-site-optimisation.html"},"url":"https://st4lk.github.io/en/blog/2013/04/12/django-admin-site-optimisation.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="shortcut icon" type="image/png" href="/favicon.png">
  <link rel="stylesheet" href="/en/assets/main.css">
  <link rel="stylesheet" href="/en/assets/css/styles.css"><link type="application/atom+xml" rel="alternate" href="https://st4lk.github.io/en/feed.xml" title="Developer articles" /><script async defer src="https://buttons.github.io/buttons.js"></script>
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/en/">Developer Articles</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          <a class="page-link" href="/en/blog/">Blog</a>
          <a class="page-link" href="/en/about/">About</a>
          <a class="page-link" style="margin-right: 0px" href="/blog/2013/04/12/django-admin-site-optimisation.html" ><img src="/en/assets/images/ru.png" /></a>
          <a class="page-link" href="/en/blog/2013/04/12/django-admin-site-optimisation.html" ><img src="/en/assets/images/en.png" /></a>
          <a class="page-link" href="/en/search/" ><img src="/en/assets/images/search.svg" /></a>
        </div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Django admin site optimisation</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2013-04-12T18:19:43+00:00" itemprop="datePublished">Apr 12, 2013
      </time><span style="float:right">

  <span><a href="/en/category/django/index.html">django</a></span>
&nbsp;

  <span><a href="/en/category/database/index.html">database</a></span>
&nbsp;

  <span><a href="/en/category/sql/index.html">sql</a></span>


</span>
    </p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><a href="/en/blog/2013/04/12/django-admin-site-optimisation.html"><img src="/assets/images/posts/2013-04-12-django-admin-site-optimisation/django-admin-performance.png" alt="Django admin site optimisation" title="Django admin site optimisation" /></a></p>

<p>It is known, that less amount of database attempts leads to better performance. Usually admin page - part of site with low traffic, but anyway it is good, if no additional database calls happen there. It is more pleasant to use it, because page renders faster and also frees server resources.</p>

<p>In this post i’ll try to reduce some database attempts in admin page, when model method <code class="language-plaintext highlighter-rouge">__unicode__</code> contains related object field. I suppose, that examples describe the situation more clear.</p>

<!--more-->

<h3 id="1-unicode-at-admin-change-form-page">1. <strong>unicode</strong> at admin change form page</h3>

<p>Lets take a look at following example: there are SubwayStation, SubwayLine and City models. SubwayLine is ForeignKey for SubwayStation and City - ForeignKey for SubwayLine.</p>

<p><code class="language-plaintext highlighter-rouge">models.py</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span> <span class="nc">City</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">name</span>


<span class="k">class</span> <span class="nc">SubwayLine</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">city</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">City</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">'lines'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">u</span><span class="s">"{0}, {1}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">city</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SubwayStation</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">SubwayLine</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">'stations'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">name</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">admin.py</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">SubwayLine</span><span class="p">,</span> <span class="n">SubwayStation</span><span class="p">,</span> <span class="n">City</span>


<span class="k">class</span> <span class="nc">SubwayLineAdmin</span><span class="p">(</span><span class="n">admin</span><span class="p">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="s">'name'</span><span class="p">,</span>


<span class="k">class</span> <span class="nc">SubwayStationAdmin</span><span class="p">(</span><span class="n">admin</span><span class="p">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="s">'name'</span><span class="p">,</span> <span class="s">'line'</span>


<span class="k">class</span> <span class="nc">CityAdmin</span><span class="p">(</span><span class="n">admin</span><span class="p">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="s">'name'</span><span class="p">,</span>


<span class="n">admin</span><span class="p">.</span><span class="n">site</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="n">SubwayLine</span><span class="p">,</span> <span class="n">SubwayLineAdmin</span><span class="p">)</span>
<span class="n">admin</span><span class="p">.</span><span class="n">site</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="n">SubwayStation</span><span class="p">,</span> <span class="n">SubwayStationAdmin</span><span class="p">)</span>
<span class="n">admin</span><span class="p">.</span><span class="n">site</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="n">City</span><span class="p">,</span> <span class="n">CityAdmin</span><span class="p">)</span>
</code></pre></div></div>

<p>Now visit SubwayStation change page</p>

<p><img src="/assets/images/posts/2013-04-12-django-admin-site-optimisation/station_change.png" alt="SubwayStation change form page" title="SubwayStation change form page" /></p>

<p>As we can see, <code class="language-plaintext highlighter-rouge">__unicode__</code> for SubwayLine consist of two fields: related City.name and its own SubwayLine.name.</p>

<p>Check database attempts were performed to show this page (attempts to tables django_session, auth_user, django_content_type are not taken into account) :</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"name"</span><span class="p">,</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"line_id"</span> <span class="k">FROM</span> <span class="nv">"main_subwaystation"</span> <span class="k">WHERE</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"name"</span><span class="p">,</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"city_id"</span> <span class="k">FROM</span> <span class="nv">"main_subwayline"</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">;</span>
</code></pre></div></div>

<p>Following requests are made:</p>

<ul>
  <li>first - get station record</li>
  <li>second - get all lines</li>
  <li>others - get city for each line</li>
</ul>

<p>So we have (2 + amount of lines) attempts. It is a lot.</p>

<h4 id="there-are-two-ways-to-fix-the-situation">There are two ways to fix the situation</h4>

<ul>
  <li>
    <p>Use <a href="https://docs.djangoproject.com/en/dev/ref/models/querysets/#select-related">select_related</a> in queryset</p>

    <p>It is needed to define form for SubwayStation ModelAdmin:</p>

    <p><code class="language-plaintext highlighter-rouge">admin.py</code>:</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
  <span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
  <span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">SubwayLine</span><span class="p">,</span> <span class="n">SubwayStation</span><span class="p">,</span> <span class="n">City</span>


  <span class="k">class</span> <span class="nc">SubwayLineAdmin</span><span class="p">(</span><span class="n">admin</span><span class="p">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
      <span class="n">list_display</span> <span class="o">=</span> <span class="s">'name'</span><span class="p">,</span>


  <span class="k">class</span> <span class="nc">SubwayStationForm</span><span class="p">(</span><span class="n">forms</span><span class="p">.</span><span class="n">ModelForm</span><span class="p">):</span>

      <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
          <span class="nb">super</span><span class="p">(</span><span class="n">SubwayStationForm</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
          <span class="bp">self</span><span class="p">.</span><span class="n">fields</span><span class="p">[</span><span class="s">'line'</span><span class="p">].</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">SubwayLine</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>\
              <span class="p">.</span><span class="n">select_related</span><span class="p">(</span><span class="s">'city'</span><span class="p">)</span>

      <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
          <span class="n">model</span> <span class="o">=</span> <span class="n">SubwayStation</span>


  <span class="k">class</span> <span class="nc">SubwayStationAdmin</span><span class="p">(</span><span class="n">admin</span><span class="p">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
      <span class="n">list_display</span> <span class="o">=</span> <span class="s">'name'</span><span class="p">,</span>
      <span class="n">form</span> <span class="o">=</span> <span class="n">SubwayStationForm</span>


  <span class="k">class</span> <span class="nc">CityAdmin</span><span class="p">(</span><span class="n">admin</span><span class="p">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
      <span class="n">list_display</span> <span class="o">=</span> <span class="s">'name'</span><span class="p">,</span>


  <span class="n">admin</span><span class="p">.</span><span class="n">site</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="n">SubwayLine</span><span class="p">,</span> <span class="n">SubwayLineAdmin</span><span class="p">)</span>
  <span class="n">admin</span><span class="p">.</span><span class="n">site</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="n">SubwayStation</span><span class="p">,</span> <span class="n">SubwayStationAdmin</span><span class="p">)</span>
  <span class="n">admin</span><span class="p">.</span><span class="n">site</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="n">City</span><span class="p">,</span> <span class="n">CityAdmin</span><span class="p">)</span>
</code></pre></div>    </div>

    <p>And now we have only two database calls (thanks to INNER JOIN):</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">SELECT</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"name"</span><span class="p">,</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"line_id"</span> <span class="k">FROM</span> <span class="nv">"main_subwaystation"</span> <span class="k">WHERE</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
  <span class="k">SELECT</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"name"</span><span class="p">,</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"city_id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_subwayline"</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">"main_city"</span> <span class="k">ON</span> <span class="p">(</span><span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"city_id"</span> <span class="o">=</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Use <a href="https://docs.djangoproject.com/en/dev/ref/contrib/admin/#django.contrib.admin.ModelAdmin.raw_id_fields">raw_id_fields</a> (usefull, when there are big amount of records so it is not comfortable and expensive to show them in selectbox)</p>

    <p>Set raw_id_fields for SubwayStationAdmin:</p>

    <p><code class="language-plaintext highlighter-rouge">admin.py</code>:</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">class</span> <span class="nc">SubwayStationAdmin</span><span class="p">(</span><span class="n">admin</span><span class="p">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
      <span class="n">list_display</span> <span class="o">=</span> <span class="s">'name'</span><span class="p">,</span>
      <span class="n">raw_id_fields</span> <span class="o">=</span> <span class="s">'line'</span><span class="p">,</span>
</code></pre></div>    </div>

    <p>Here how page now looks like:</p>

    <p><img src="/assets/images/posts/2013-04-12-django-admin-site-optimisation/station_change_rawid.png" alt="SubwayStation change form page with line as raw_id_field" title="SubwayStation change form page with line as raw_id_field" /></p>

    <p>Check database attempts:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">SELECT</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"name"</span><span class="p">,</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"line_id"</span> <span class="k">FROM</span> <span class="nv">"main_subwaystation"</span> <span class="k">WHERE</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
  <span class="k">SELECT</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"name"</span><span class="p">,</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"city_id"</span> <span class="k">FROM</span> <span class="nv">"main_subwayline"</span> <span class="k">WHERE</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
  <span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span><span class="mi">1</span><span class="p">,)</span>
</code></pre></div>    </div>

    <p>Three calls, where third is for showing city in SubwayStations’s <strong>unicode</strong>. Good. If we want, we can go further and make only two calls (exclude third request). We’ll need to redefine ForeignKeyRawIdWidget widget:</p>

    <p><code class="language-plaintext highlighter-rouge">admin.py</code>:</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
  <span class="kn">from</span> <span class="nn">django.contrib.admin.widgets</span> <span class="kn">import</span> <span class="n">ForeignKeyRawIdWidget</span>
  <span class="kn">from</span> <span class="nn">django.contrib.admin.sites</span> <span class="kn">import</span> <span class="n">site</span>
  <span class="kn">from</span> <span class="nn">django.utils.text</span> <span class="kn">import</span> <span class="n">Truncator</span>
  <span class="kn">from</span> <span class="nn">django.utils.html</span> <span class="kn">import</span> <span class="n">escape</span>
  <span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
  <span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">SubwayLine</span><span class="p">,</span> <span class="n">SubwayStation</span><span class="p">,</span> <span class="n">City</span>


  <span class="k">class</span> <span class="nc">SubwayLineAdmin</span><span class="p">(</span><span class="n">admin</span><span class="p">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
      <span class="n">list_display</span> <span class="o">=</span> <span class="s">'name'</span><span class="p">,</span>


  <span class="k">class</span> <span class="nc">StationForeignKeyRawIdWidget</span><span class="p">(</span><span class="n">ForeignKeyRawIdWidget</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">label_for_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
          <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">rel</span><span class="p">.</span><span class="n">get_related_field</span><span class="p">().</span><span class="n">name</span>
          <span class="k">try</span><span class="p">:</span>
              <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">rel</span><span class="p">.</span><span class="n">to</span><span class="p">.</span><span class="n">_default_manager</span><span class="p">.</span><span class="n">select_related</span><span class="p">(</span><span class="s">'city'</span><span class="p">).</span><span class="n">using</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">).</span><span class="n">get</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
              <span class="k">return</span> <span class="s">'&amp;nbsp;&lt;strong&gt;%s&lt;/strong&gt;'</span> <span class="o">%</span> <span class="n">escape</span><span class="p">(</span><span class="n">Truncator</span><span class="p">(</span><span class="n">obj</span><span class="p">).</span><span class="n">words</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="s">'...'</span><span class="p">))</span>
          <span class="k">except</span> <span class="p">(</span><span class="nb">ValueError</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">rel</span><span class="p">.</span><span class="n">to</span><span class="p">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
              <span class="k">return</span> <span class="s">''</span>


  <span class="k">class</span> <span class="nc">SubwayStationForm</span><span class="p">(</span><span class="n">forms</span><span class="p">.</span><span class="n">ModelForm</span><span class="p">):</span>

      <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
          <span class="nb">super</span><span class="p">(</span><span class="n">SubwayStationForm</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
          <span class="bp">self</span><span class="p">.</span><span class="n">fields</span><span class="p">[</span><span class="s">'line'</span><span class="p">].</span><span class="n">widget</span> <span class="o">=</span> <span class="n">StationForeignKeyRawIdWidget</span><span class="p">(</span>
              <span class="n">SubwayStation</span><span class="p">.</span><span class="n">_meta</span><span class="p">.</span><span class="n">get_field</span><span class="p">(</span><span class="s">"line"</span><span class="p">).</span><span class="n">rel</span><span class="p">,</span> <span class="n">site</span><span class="p">)</span>

      <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
          <span class="n">model</span> <span class="o">=</span> <span class="n">SubwayStation</span>


  <span class="k">class</span> <span class="nc">SubwayStationAdmin</span><span class="p">(</span><span class="n">admin</span><span class="p">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
      <span class="n">list_display</span> <span class="o">=</span> <span class="s">'name'</span><span class="p">,</span>
      <span class="n">raw_id_fields</span> <span class="o">=</span> <span class="s">'line'</span><span class="p">,</span>
      <span class="n">form</span> <span class="o">=</span> <span class="n">SubwayStationForm</span>


  <span class="k">class</span> <span class="nc">CityAdmin</span><span class="p">(</span><span class="n">admin</span><span class="p">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
      <span class="n">list_display</span> <span class="o">=</span> <span class="s">'name'</span><span class="p">,</span>


  <span class="n">admin</span><span class="p">.</span><span class="n">site</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="n">SubwayLine</span><span class="p">,</span> <span class="n">SubwayLineAdmin</span><span class="p">)</span>
  <span class="n">admin</span><span class="p">.</span><span class="n">site</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="n">SubwayStation</span><span class="p">,</span> <span class="n">SubwayStationAdmin</span><span class="p">)</span>
  <span class="n">admin</span><span class="p">.</span><span class="n">site</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="n">City</span><span class="p">,</span> <span class="n">CityAdmin</span><span class="p">)</span>
</code></pre></div>    </div>

    <p>And now only two requests are made:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">SELECT</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"name"</span><span class="p">,</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"line_id"</span> <span class="k">FROM</span> <span class="nv">"main_subwaystation"</span> <span class="k">WHERE</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
  <span class="k">SELECT</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"name"</span><span class="p">,</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"city_id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_subwayline"</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">"main_city"</span> <span class="k">ON</span> <span class="p">(</span><span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"city_id"</span> <span class="o">=</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">)</span> <span class="k">WHERE</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
</code></pre></div>    </div>

    <p>Note, that given code with redefined ForeignKeyRawIdWidget will work with django 1.4, 1.5. For earlier version method <code class="language-plaintext highlighter-rouge">label_for_value</code> differs, so it is needed to copy this method from class ForeignKeyRawIdWidget from module django/contrib/admin/widgets.py and add to it <code class="language-plaintext highlighter-rouge">.select_related('city')</code>.</p>
  </li>
</ul>

<h3 id="2-__unicode__-in-inline-forms">2. <code class="language-plaintext highlighter-rouge">__unicode__</code> in inline forms</h3>

<p>Described solutions can be applied to inline admin objects. Lets say, that we have additional model District. And SubwayStation has ForeignKey to it:</p>

<p><code class="language-plaintext highlighter-rouge">models.py</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ...
</span>
<span class="k">class</span> <span class="nc">District</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">city</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">City</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">'districts'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">u</span><span class="s">"{0}, {1}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">city</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SubwayStation</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">SubwayLine</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">'stations'</span><span class="p">)</span>
    <span class="n">district</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">District</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">'stations'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">name</span>

<span class="c1"># ...
</span></code></pre></div></div>

<p>As we can see, District <code class="language-plaintext highlighter-rouge">__unicode__</code> includes related field City.name. Now add SubwayStation as inline to SubwayLine:</p>

<p><code class="language-plaintext highlighter-rouge">admin.py</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ...
</span>
<span class="k">class</span> <span class="nc">SubwayStationInline</span><span class="p">(</span><span class="n">admin</span><span class="p">.</span><span class="n">TabularInline</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">SubwayStation</span>
    <span class="n">extra</span> <span class="o">=</span> <span class="mi">0</span>


<span class="k">class</span> <span class="nc">SubwayLineAdmin</span><span class="p">(</span><span class="n">admin</span><span class="p">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="s">'name'</span><span class="p">,</span>
    <span class="n">inlines</span> <span class="o">=</span> <span class="n">SubwayStationInline</span><span class="p">,</span>

<span class="c1"># ...
</span></code></pre></div></div>

<p>Open SubwayLine change page:</p>

<p><img src="/assets/images/posts/2013-04-12-django-admin-site-optimisation/line_change_inline.png" alt="SubwayLine change form page with SubwayStation inline" title="SubwayLine change form page with SubwayStation inline" /></p>

<p>Check database calls (i’ve made only two stations for this line, and three districts in total):</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"name"</span><span class="p">,</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"city_id"</span> <span class="k">FROM</span> <span class="nv">"main_subwayline"</span> <span class="k">WHERE</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"name"</span><span class="p">,</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"line_id"</span><span class="p">,</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"district_id"</span> <span class="k">FROM</span> <span class="nv">"main_subwaystation"</span> <span class="k">WHERE</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"line_id"</span> <span class="o">=</span> <span class="mi">1</span>  <span class="k">ORDER</span> <span class="k">BY</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">ASC</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span><span class="mi">1</span><span class="p">,)</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_district"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_district"</span><span class="p">.</span><span class="nv">"name"</span><span class="p">,</span> <span class="nv">"main_district"</span><span class="p">.</span><span class="nv">"city_id"</span> <span class="k">FROM</span> <span class="nv">"main_district"</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span><span class="mi">1</span><span class="p">,)</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span><span class="mi">1</span><span class="p">,)</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span><span class="mi">1</span><span class="p">,)</span>
<span class="k">SELECT</span> <span class="nv">"main_district"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_district"</span><span class="p">.</span><span class="nv">"name"</span><span class="p">,</span> <span class="nv">"main_district"</span><span class="p">.</span><span class="nv">"city_id"</span> <span class="k">FROM</span> <span class="nv">"main_district"</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span><span class="mi">1</span><span class="p">,)</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span><span class="mi">1</span><span class="p">,)</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span><span class="mi">1</span><span class="p">,)</span>
<span class="k">SELECT</span> <span class="nv">"main_district"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_district"</span><span class="p">.</span><span class="nv">"name"</span><span class="p">,</span> <span class="nv">"main_district"</span><span class="p">.</span><span class="nv">"city_id"</span> <span class="k">FROM</span> <span class="nv">"main_district"</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span><span class="mi">1</span><span class="p">,)</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span><span class="mi">1</span><span class="p">,)</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span><span class="mi">1</span><span class="p">,)</span>
</code></pre></div></div>

<p>For each inline station there is request to get all distrcits + for each district request to get city. Here we can exclude city request for each district by adding <code class="language-plaintext highlighter-rouge">select_related('city')</code> in Inline form:</p>

<p><code class="language-plaintext highlighter-rouge">admin.py</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ...
</span>
<span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">SubwayLine</span><span class="p">,</span> <span class="n">SubwayStation</span><span class="p">,</span> <span class="n">City</span><span class="p">,</span> <span class="n">District</span>


<span class="k">class</span> <span class="nc">SubwayStationForm</span><span class="p">(</span><span class="n">forms</span><span class="p">.</span><span class="n">ModelForm</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SubwayStationForm</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">fields</span><span class="p">[</span><span class="s">'district'</span><span class="p">].</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">District</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>\
            <span class="p">.</span><span class="n">select_related</span><span class="p">(</span><span class="s">'city'</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">SubwayStation</span>


<span class="k">class</span> <span class="nc">SubwayStationInline</span><span class="p">(</span><span class="n">admin</span><span class="p">.</span><span class="n">TabularInline</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">SubwayStation</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">SubwayStationForm</span>
    <span class="n">extra</span> <span class="o">=</span> <span class="mi">0</span>


<span class="k">class</span> <span class="nc">SubwayLineAdmin</span><span class="p">(</span><span class="n">admin</span><span class="p">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="s">'name'</span><span class="p">,</span>
    <span class="n">inlines</span> <span class="o">=</span> <span class="n">SubwayStationInline</span><span class="p">,</span>

<span class="c1"># ...
</span></code></pre></div></div>

<p>Now there are no separate city requests:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"name"</span><span class="p">,</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"city_id"</span> <span class="k">FROM</span> <span class="nv">"main_subwayline"</span> <span class="k">WHERE</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"name"</span><span class="p">,</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"line_id"</span><span class="p">,</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"district_id"</span> <span class="k">FROM</span> <span class="nv">"main_subwaystation"</span> <span class="k">WHERE</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"line_id"</span> <span class="o">=</span> <span class="mi">1</span>  <span class="k">ORDER</span> <span class="k">BY</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">ASC</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span><span class="mi">1</span><span class="p">,)</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_district"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_district"</span><span class="p">.</span><span class="nv">"name"</span><span class="p">,</span> <span class="nv">"main_district"</span><span class="p">.</span><span class="nv">"city_id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_district"</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">"main_city"</span> <span class="k">ON</span> <span class="p">(</span><span class="nv">"main_district"</span><span class="p">.</span><span class="nv">"city_id"</span> <span class="o">=</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">);</span>
<span class="k">SELECT</span> <span class="nv">"main_district"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_district"</span><span class="p">.</span><span class="nv">"name"</span><span class="p">,</span> <span class="nv">"main_district"</span><span class="p">.</span><span class="nv">"city_id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_district"</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">"main_city"</span> <span class="k">ON</span> <span class="p">(</span><span class="nv">"main_district"</span><span class="p">.</span><span class="nv">"city_id"</span> <span class="o">=</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">);</span>
<span class="k">SELECT</span> <span class="nv">"main_district"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_district"</span><span class="p">.</span><span class="nv">"name"</span><span class="p">,</span> <span class="nv">"main_district"</span><span class="p">.</span><span class="nv">"city_id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_district"</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">"main_city"</span> <span class="k">ON</span> <span class="p">(</span><span class="nv">"main_district"</span><span class="p">.</span><span class="nv">"city_id"</span> <span class="o">=</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="3-__unicode__-at-change-list-page">3. <code class="language-plaintext highlighter-rouge">__unicode__</code> at change list page</h3>

<p>Lets look at SubwayStation change list page. I’ll remind the code:</p>

<p><code class="language-plaintext highlighter-rouge">models.py</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ...
</span>
<span class="k">class</span> <span class="nc">SubwayLine</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">city</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">City</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">'lines'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">u</span><span class="s">"{0}, {1}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">city</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SubwayStation</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">SubwayLine</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">'stations'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">name</span>

<span class="c1"># ...
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">admin.py</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ...
</span>
<span class="k">class</span> <span class="nc">SubwayStationAdmin</span><span class="p">(</span><span class="n">admin</span><span class="p">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="s">'name'</span><span class="p">,</span> <span class="s">'line'</span>

<span class="c1"># ...
</span></code></pre></div></div>

<p>Open the page:</p>

<p><img src="/assets/images/posts/2013-04-12-django-admin-site-optimisation/station_list.png" alt="SubwayStation change list page" title="SubwayStation change list page" /></p>

<p>For each station there is line field. And <strong>unicode</strong> of line includes city name.</p>

<p>Database attempts:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="nv">"main_subwaystation"</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"name"</span><span class="p">,</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"line_id"</span><span class="p">,</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"name"</span><span class="p">,</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"city_id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_subwaystation"</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">"main_subwayline"</span> <span class="k">ON</span> <span class="p">(</span><span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"line_id"</span> <span class="o">=</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">)</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">"main_city"</span> <span class="k">ON</span> <span class="p">(</span><span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"city_id"</span> <span class="o">=</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">)</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">DESC</span><span class="p">;</span>
</code></pre></div></div>

<p>Looks good. Django <a href="https://docs.djangoproject.com/en/dev/ref/contrib/admin/#django.contrib.admin.ModelAdmin.list_select_related">have already used select_related</a> at change list page. <strong>But there is a little trap</strong>. Reading <a href="https://docs.djangoproject.com/en/dev/ref/models/querysets/#django.db.models.query.QuerySet.select_related">documentation about select_related</a> carefully we can see, that</p>

<blockquote>
  <p>by default, select_related() does not follow foreign keys that have null=True.</p>
</blockquote>

<p>So in our case select_related works, because we don’t have null=True for ForeignKey.</p>

<p>Lets add <code class="language-plaintext highlighter-rouge">null=True</code>:</p>

<p><code class="language-plaintext highlighter-rouge">models.py</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ...
</span>
<span class="k">class</span> <span class="nc">SubwayStation</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">SubwayLine</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">'stations'</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">name</span>

<span class="c1"># ...
</span></code></pre></div></div>

<p>Open change list page and look at database attempts:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="nv">"main_subwaystation"</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"name"</span><span class="p">,</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"line_id"</span><span class="p">,</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"name"</span><span class="p">,</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"city_id"</span> <span class="k">FROM</span> <span class="nv">"main_subwaystation"</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">"main_subwayline"</span> <span class="k">ON</span> <span class="p">(</span><span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"line_id"</span> <span class="o">=</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">)</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="nv">"main_subwaystation"</span>  <span class="n">SC</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_city"</span> <span class="k">WHERE</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
</code></pre></div></div>

<p>Oops. Now, to show <code class="language-plaintext highlighter-rouge">__unicode__</code> for each SubwayLine separate database call to main_city table happens. To avoid this amount of calls, we have to redefine queryset for change list page (specify select_related with needed fields explicitly):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ...
</span>
<span class="k">class</span> <span class="nc">SubwayStationAdmin</span><span class="p">(</span><span class="n">admin</span><span class="p">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="s">'name'</span><span class="p">,</span> <span class="s">'line'</span>

    <span class="k">def</span> <span class="nf">queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">SubwayStationAdmin</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">queryset</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span><span class="p">.</span><span class="n">select_related</span><span class="p">(</span><span class="s">'line__city'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qs</span>
<span class="c1"># ...
</span></code></pre></div></div>

<p>Now all good:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="nv">"main_subwaystation"</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"name"</span><span class="p">,</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"line_id"</span><span class="p">,</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"name"</span><span class="p">,</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"city_id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">FROM</span> <span class="nv">"main_subwaystation"</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">"main_subwayline"</span> <span class="k">ON</span> <span class="p">(</span><span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"line_id"</span> <span class="o">=</span> <span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">)</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="nv">"main_city"</span> <span class="k">ON</span> <span class="p">(</span><span class="nv">"main_subwayline"</span><span class="p">.</span><span class="nv">"city_id"</span> <span class="o">=</span> <span class="nv">"main_city"</span><span class="p">.</span><span class="nv">"id"</span><span class="p">)</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="nv">"main_subwaystation"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">DESC</span><span class="p">;</span>
</code></pre></div></div>

  </div>

  <div class="post-categories">

  <span><a href="/en/category/django/index.html">django</a></span>
&nbsp;

  <span><a href="/en/category/database/index.html">database</a></span>
&nbsp;

  <span><a href="/en/category/sql/index.html">sql</a></span>


</div><a class="u-url" href="/en/blog/2013/04/12/django-admin-site-optimisation.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/en/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Developer articles</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Developer articles</li><li><a class="u-email" href="mailto:alexevseev@gmail.com">alexevseev@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/st4lk"><svg class="svg-icon"><use xlink:href="/en/assets/minima-social-icons.svg#github"></use></svg> <span class="username">st4lk</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
